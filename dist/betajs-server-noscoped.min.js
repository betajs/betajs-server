/*!
betajs-server - v1.0.26 - 2019-12-13
Copyright (c) Oliver Friedmann
Apache-2.0 Software License.
*/

(function(){var d=this.subScope();d.binding("module","global:BetaJS.Server"),d.binding("base","global:BetaJS"),d.binding("data","global:BetaJS.Data"),d.define("module:",function(){return{guid:"9955100d-6a88-451f-9a85-004523eb8589",version:"1.0.26",datetime:1576297258739}}),d.assumeVersion("base:version","~1.0.104"),d.assumeVersion("data:version","~1.0.41"),d.define("module:Ajax.NodeAjax",["base:Ajax.Support","base:Net.Uri","base:Net.HttpHeader","base:Promise","base:Objs","base:Types"],function(c,u,d,h,l,f){var e={supports:function(e){return!0},execute:function(t){var e=u.appendUriParams(t.uri,t.query||{});"GET"===t.method&&(e=u.appendUriParams(e,t.data||{}));var s=u.parse(e),i={method:t.method,host:s.host,port:s.port,path:s.path+(s.query?"?"+s.query:""),headers:{}};s.user||s.password?i.headers.Authorization="Basic "+new Buffer(s.user+":"+s.password).toString("base64"):t.bearer&&(i.headers.Authorization="Bearer "+t.bearer);var n=null,o=null;if("GET"!==t.method&&!f.is_empty(t.data)){var r=require("fs");l.iter(t.data,function(e){!o&&e instanceof r.ReadStream&&(o=new(require("form-data")))}),o?l.iter(t.data,function(e,s){o.append(s,e)}):n="json"===t.contentType?(t.sendContentType&&(i.headers["Content-Type"]="application/json;charset=UTF-8"),JSON.stringify(t.data)):(t.sendContentType&&(i.headers["Content-type"]="application/x-www-form-urlencoded"),u.encodeUriParams(t.data,undefined,!0)),n&&(i.headers["Content-Length"]=n.length)}var a=h.create();t.cookies&&(i.headers.Cookie=u.encodeUriParams(t.cookies)),o&&(i.headers=l.extend(i.headers,o.getHeaders()));var _=require("https"===s.protocol?"https":"http").request(i,function(e){var s="";e.on("data",function(e){s+=e}).on("end",function(){d.isSuccessStatus(e.statusCode)?c.promiseReturnData(a,t,s,t.decodeType||"json"):c.promiseRequestException(a,e.statusCode,e.statusText,s,t.decodeType||"json")})});return t.timeout&&_.on("socket",function(e){e.removeAllListeners("timeout"),e.setTimeout(t.timeout,function(){}),e.on("timeout",function(){_.abort()})}).on("timeout",function(){c.promiseTimeoutException(a),_.abort()}),o?o.pipe(_):(n&&0<n.length&&_.write(n),_.end()),a}};return c.register(e,10),e}),d.define("module:Net.ControllerException",["base:Exceptions.Exception","base:Net.HttpHeader"],function(e,i,s){return e.extend({scoped:s},function(t){return{constructor:function(e,s){s=s||{},this.__data=s,this.__code=e,t.constructor.call(this,i.format(e,!0))},code:function(){return this.__code},data:function(){return this.__data}}})}),d.define("module:Net.Controller",["base:Class","base:Promise","base:Types","module:Net.ControllerException"],function(e,o,r,a,s){return e.extend({scoped:s},{},{_beforeDispatch:function(e,s,t){return o.create(!0)},_dispatch:function(e,s,t){return this[e](s,t)},dispatch:function(s,t,i,n){this._beforeDispatch(s,t,i).success(function(){var e=this._dispatch(s,t,i);(e=o.is(e)?e:o.create(!0)).success(function(){r.is_defined(n)&&n()}).error(function(e){e=a.ensure(e),i.status(e.code()).send(JSON.stringify(e.data()))})},this).error(function(e){e=a.ensure(e),i.status(e.code()).send(JSON.stringify(e.data()))})}})}),d.define("module:Net.SessionControllerMixin",function(){return{_obtainSession:function(s,t,e,i,n){return s.obtain_session(i.cookies[t]).mapSuccess(function(e){return i.session=e,n.cookie(t,e.cid(),{maxAge:s.options().invalidation.session_timeout}),e})}}}),d.define("module:Sessions.ActiveSessionHelper",["base:Class","base:Classes.HelperClassMixin","base:Lists.ObjectIdList","base:Tokens"],function(e,s,i,n,t){return e.extend({scoped:t},[s,function(t){return{constructor:function(e,s){t.constructor.call(this),this.__helper=s,((this.__session=e).active_sessions=this).__active_sessions=new i},destroy:function(){this.iterate(function(e){e.destroy()},this),this.__active_sessions.destroy(),t.destroy.call(this)},session:function(){return this.__session},helper:function(){return this.__helper},invalidate:function(){this.iterate(function(e){e.invalidate()},this)},iterate:function(e,s){this.__active_sessions.iterate(e,s||this)},is_active:function(){return 0<this.__active_sessions.count()},find_active_session:function(e){return this.__active_sessions.get(e)},__generate_token:function(){return n.generate_token()},__remove_active_session:function(e){this.__active_sessions.exists(e)&&(this.__active_sessions.remove(e),this.__session.activity())},delete_active_session:function(e){e.destroy()},obtain_active_session:function(e,s){return this.find_active_session(e)||this.new_active_session(e,s)},__add_active_session:function(e){this.__active_sessions.add(e),this.session().manager().__add_active_session(this.session(),e)},new_active_session:function(e,s){var t=new this.__helper._active_session_class(this,e||this.__generate_token(),s);return this.__add_active_session(t),t},continue_active_session:function(s){var t=null;return this.iterate(function(e){return!e.suspended()||!e.can_continue(s)||(t=e,!1)}),t},attach_active_session:function(e){return this.continue_active_session(e)||this.new_active_session(null,e)}}}])}),d.define("module:Sessions.ActiveSession",["base:Class","base:Classes.HelperClassMixin","base:Events.EventsMixin","base:Ids","base:Time"],function(e,s,t,n,o,i){return e.extend({scoped:i},[s,t,function(i){return{constructor:function(e,s,t){i.constructor.call(this),this.__helper=e,this.__options=t||{},n.objectId(this,s),this.initiation_time=o.now(),this.active_time=this.initiation_time},destroy:function(){this.trigger("destroy"),this.__helper.__remove_active_session(this),i.destroy.call(this)},session:function(){return this.__helper.session()},options:function(){return this.__options},activity:function(){this.active_time=o.now()},suspended:function(){return this._helper({method:"suspended",fold_start:!1,fold:function(e,s){return e||s}})},can_continue:function(e){return!1},invalidate:function(){var e=this.__helper.helper().options().invalidation,s=o.now();(e.active_session_timeout&&s>this.initiation_time+e.active_session_timeout||this.suspended()&&e.active_session_inactivity_timeout&&s>this.active_time+e.active_session_inactivity_timeout)&&this.destroy()}}}])}),d.define("module:Sessions.ActiveSessionManagerHelper",["base:Class","module:Sessions.ActiveSession","module:Sessions.ActiveSessionHelper","base:Objs","base:Types"],function(e,s,i,n,o,t){return e.extend({scoped:t},function(t){return{_active_session_class:s,constructor:function(e,s){t.constructor.call(this),s=n.tree_extend({invalidation:{active_session_timeout:36e5,active_session_inactivity_timeout:6e4}},s),this.__options=s,this._active_session_class=s.active_session_class||this._active_session_class,o.is_string(this._active_session_class)&&(this._active_session_class=d.getGlobal(this._active_session_class)),e.__add_active_session=function(e,s){this._helper("__add_active_session",e,s)}},__add_session:function(e){e.addHelper(i,this)},options:function(){return this.__options}}})}),d.define("module:Sessions.PersistentSessionModel",["data:Modelling.Model"],function(e,s){return e.extend({scoped:s},{},function(s){return{_initializeScheme:function(){var e=s._initializeScheme.call(this);return e.token={type:"string",index:!0},e.created={type:"date",index:!0},e}}})}),d.define("module:Sessions.PersistentSessionManagerHelper",["base:Class","module:Sessions.PersistentSessionModel","base:Objs","base:Types","data:Stores.MemoryStore","data:Modelling.Table","base:Timers.Timer","base:Time"],function(e,s,i,n,o,r,a,_,t){return e.extend({scoped:t},function(t){return{_persistent_session_model:s,constructor:function(e,s){t.constructor.call(this),this.__manager=e,s=i.tree_extend({invalidation:{session_timeout:31536e6,timer:864e5}},s),this.__options=s,this.__store=s.store?s.store:this._auto_destroy(new o),this._persistent_session_model=s.persistent_session_model||this._persistent_session_model,n.is_string(this._persistent_session_model)&&(this._persistent_session_model=d.getGlobal(this._persistent_session_model)),s.invalidation.timer&&(this.__timer=this._auto_destroy(new a({fire:this.invalidate,context:this,delay:s.invalidation.timer}))),this._persistent_session_model.table||(this._persistent_session_model.table=this._auto_destroy(new r(this.__store,this._persistent_session_model))),this.__table=this._persistent_session_model.table,e.table=this.__table,e.store=this.__store},__lookup_session:function(t){return this.__table.findBy({token:t}).mapCallback(function(e,s){return s&&!e?this.__manager.new_session(t,{model:s}):null},this)},__add_session:function(e){var s=e.options();s.model||(s.model=this.__table.newModel({token:e.cid(),created:_.now()}),s.model.save()),e.model=s.model,e.model.session=e},options:function(){return this.__options},invalidate:function(){if(this.__options.invalidation.session_timeout){var e=_.now()-this.__options.invalidation.session_timeout;this.__table.allBy({created:{$lt:e}}).success(function(e){for(;e.hasNext();){var s=e.next();s.session&&this.__manager.delete_session(s.session),s.remove()}},this)}}}})}),d.define("module:Sessions.RMIHelper",["base:Class","base:Channels.ReadySender","base:Net.SocketSenderChannel","base:Net.SocketReceiverChannel","base:RMI.Peer"],function(e,t,i,n,o,s){return e.extend({scoped:s},function(s){return{constructor:function(e){s.constructor.call(this),((this.__active_session=e).rmi=this).__rmi_sender=new t(new i(null,"rmi")),this.__rmi_receiver=new n(null,"rmi"),this.__rmi_peer=new o(this.__rmi_sender,this.__rmi_receiver),e.rmi_peer=this.__rmi_peer,this.stubs={},this.skeletons={},e.stubs=this.stubs,e.skeletons=this.skeletons,e.on("bind_socket",function(e){this.__rmi_receiver.socket(e),this.__rmi_sender.socket(e),this.__rmi_sender.ready()},this),e.on("unbind_socket",function(){this.__rmi_sender.unready()},this),"initialize_rmi"in e&&e.initialize_rmi()},destroy:function(){for(var e in this.stubs)this.stubs[e].destroy();for(e in this.skeletons)this.skeletons[e].destroy();this.__rmi_peer.destroy(),this.__rmi_receiver.destroy(),this.__rmi_sender.destroy(),s.destroy.call(this)}}})}),d.define("module:Sessions.RMIManagerHelper",["base:Class","module:Sessions.RMIHelper"],function(e,t,s){return e.extend({scoped:s},{__add_active_session:function(e,s){s.addHelper(t)}})}),d.define("module:Sessions.Session",["base:Class","base:Classes.HelperClassMixin","base:Ids","base:Time"],function(e,s,n,o,t){return e.extend({scoped:t},[s,function(i){return{constructor:function(e,s,t){i.constructor.call(this),this.__manager=e,this.__options=t||{},n.objectId(this,s),this.initiation_time=o.now(),this.active_time=this.initiation_time},destroy:function(){this.__manager.__remove_session(this),i.destroy.call(this)},is_active:function(){return this._helper({method:"is_active",fold_start:!1,fold:function(e,s){return e||s}})},activity:function(){this.active_time=o.now()},invalidate:function(){this._helper("invalidate");var e=this.__manager.options().invalidation,s=o.now();(e.session_timeout&&s>this.initiation_time+e.session_timeout||!this.is_active()&&e.session_inactivity_timeout&&s>this.active_time+e.session_inactivity_timeout)&&this.destroy()},manager:function(){return this.__manager},options:function(){return this.__options}}}])}),d.define("module:Sessions.Manager",["base:Class","base:Events.EventsMixin","base:Classes.HelperClassMixin","module:Sessions.Session","base:Objs","base:Types","base:Timers.Timer","base:Lists.ObjectIdList","base:Tokens","base:Promise"],function(e,s,t,i,n,o,r,a,_,c,u){return e.extend({scoped:u},[s,t,function(s){return{_session_class:i,constructor:function(e){s.constructor.call(this),e=n.tree_extend({invalidation:{session_timeout:864e5,session_inactivity_timeout:36e5,timer:6e4}},e),this.__options=e,this._session_class=e.session_class||this._session_class,o.is_string(this._session_class)&&(this._session_class=d.getGlobal(this._session_class)),e.invalidation.timer&&(this.__timer=this._auto_destroy(new r({fire:this.invalidate,context:this,delay:e.invalidation.timer}))),this.__sessions=new a},destroy:function(){this.iterate(function(e){e.destroy()}),this.__sessions.destroy(),s.destroy.call(this)},iterate:function(e,s){this.__sessions.iterate(e,s||this)},obtain_session:function(e,s){return this.find_session(e).mapSuccess(function(e){return e||this.new_session(null,s)},this)},__generate_token:function(){return _.generate_token()},__lookup_session:function(e){return this._helper({method:"__lookup_session",async:!0},e)},get_session:function(e){return this.__sessions.get(e)},find_session:function(e){if(!e)return c.value(null);var s=this.get_session(e);return s?c.create(s):this.__lookup_session(e)},__add_session:function(e){this.__sessions.add(e),this._helper("__add_session",e)},new_session:function(e,s){var t=new this._session_class(this,e||this.__generate_token(),s);return this.__add_session(t),t},invalidate:function(){this.iterate(function(e){e.invalidate()})},options:function(){return this.__options},__remove_session:function(e){this.__sessions.exists(e)&&(this._helper("remove_session",e),this.__sessions.remove(e))},delete_session:function(e){e.destroy()}}}])}),d.define("module:Sessions.SocketsHelper",["base:Class"],function(e,s){return e.extend({scoped:s},function(s){return{constructor:function(e){s.constructor.call(this),(this.__active_session=e).socket=this},destroy:function(){this.unbind(),s.destroy.call(this)},suspended:function(){return!this.socket()},bind:function(e){if(e!=this.__socket){this.unbind(),this.__socket=e;var s=this;e.on("disconnect",function(){s.unbind()}),this.__active_session.trigger("bind_socket",e)}},unbind:function(){if(this.__socket){var e=this.__socket;this.__socket=null,this.__active_session.activity(),this.__active_session.trigger("unbind_socket",e),this.__active_session.session().manager().sockets_manager_helper.__options.remove_on_disconnect&&this.__active_session.destroy()}},socket:function(){return this.__socket}}})}),d.define("module:Sessions.SocketsManagerHelper",["base:Class","base:Objs","base:Net.Cookies","module:Sessions.SocketsHelper"],function(e,i,n,o,s){return e.extend({scoped:s},function(t){return{constructor:function(e,s){t.constructor.call(this),((this.__manager=e).sockets_manager_helper=this).__options=i.extend({remove_on_disconnect:!1},s),e.bind_socket=function(t,e,i){var s=t.handshake.query[e]||n.getCookielikeValue(t.handshake.headers.cookie,e);this.find_session(s).success(function(e){if(e){var s=e.active_sessions.find_active_session(i.active_session_token);s?s.socket.bind(t):t.disconnect()}else t.disconnect()},this)}},__add_active_session:function(e,s){s.addHelper(o)}}})})}).call(Scoped);