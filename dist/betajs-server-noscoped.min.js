/*!
betajs-server - v1.0.17 - 2017-01-15
Copyright (c) Oliver Friedmann
Apache-2.0 Software License.
*/
(function(){var a=this.subScope();a.binding("module","global:BetaJS.Server"),a.binding("base","global:BetaJS"),a.binding("data","global:BetaJS.Data"),a.define("module:",function(){return{guid:"9955100d-6a88-451f-9a85-004523eb8589",version:"1.0.17"}}),a.assumeVersion("base:version","~1.0.96"),a.assumeVersion("data:version","~1.0.41"),a.define("module:Ajax.NodeAjax",["base:Ajax.Support","base:Net.Uri","base:Net.HttpHeader","base:Promise","base:Objs","base:Types","base:Ajax.RequestException"],function(a,b,c,d,e,f,g){var h={supports:function(a){return!0},execute:function(g){var h=b.appendUriParams(g.uri,g.query||{});"GET"===g.method&&(h=b.appendUriParams(h,g.data||{}));var i=b.parse(h),j={method:g.method,host:i.host,port:i.port,path:i.path};j.headers={},i.user||i.password?j.headers.Authorization="Basic "+new Buffer(i.user+":"+i.password).toString("base64"):g.bearer&&(j.headers.Authorization="Bearer "+g.bearer);var k=null,l=null;if("GET"!==g.method&&!f.is_empty(g.data)){var m=require("fs");e.iter(g.data,function(a){!l&&a instanceof m.ReadStream&&(l=new(require("form-data")))}),l?e.iter(g.data,function(a,b){l.append(b,a)}):"json"===g.contentType?(g.sendContentType&&(j.headers["Content-Type"]="application/json;charset=UTF-8"),k=JSON.stringify(g.data)):(g.sendContentType&&(j.headers["Content-type"]="application/x-www-form-urlencoded"),k=b.encodeUriParams(g.data,void 0,!0)),k&&(j.headers["Content-Length"]=k.length)}var n=d.create();l&&(j.headers=e.extend(j.headers,l.getHeaders()));var o=require("https"===i.protocol?"https":"http").request(j,function(b){var d="";b.on("data",function(a){d+=a}).on("end",function(){c.isSuccessStatus(b.statusCode)?a.promiseReturnData(n,g,d,"json"):a.promiseRequestException(n,b.statusCode,b.statusText,d,"json")})});return l?l.pipe(o):(k&&k.length>0&&o.write(k),o.end()),n}};return a.register(h,10),h}),a.define("module:Databases.DatabaseTable",["base:Class","base:Iterators.MappedIterator"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(b,c){a.constructor.call(this),this._database=b,this._table_name=c},findOne:function(a,b){return this._findOne(this._encode(a),b).mapSuccess(function(a){return a?this._decode(a):null},this)},_findOne:function(a,b){return b=b||{},b.limit=1,this._find(a,b).mapSuccess(function(a){return a.next()})},_encode:function(a){return a},_decode:function(a){return a},_find:function(a,b){},find:function(a,c){return this._find(this._encode(a),c).mapSuccess(function(a){return new b(a,this._decode,this)},this)},findById:function(a){return this.findOne({id:a})},count:function(a){return this._count(this._encode(a))},_insertRow:function(a){},_removeRow:function(a){},_updateRow:function(a,b){},_count:function(a){},insertRow:function(a){return this._insertRow(this._encode(a)).mapSuccess(this._decode,this)},removeRow:function(a){return this._removeRow(this._encode(a))},updateRow:function(a,b){return this._updateRow(this._encode(a),this._encode(b)).mapSuccess(this._decode,this)},removeById:function(a){return this.removeRow({id:a})},updateById:function(a,b){return this.updateRow({id:a},b)},ensureIndex:function(a){}}})}),a.define("module:Databases.Database",["base:Class"],function(a,b){return a.extend({scoped:b},{_tableClass:function(){return null},getTable:function(a){var b=this._tableClass();return new b(this,a)}})}),a.define("module:Databases.MongoDatabase",["module:Databases.Database","module:Databases.MongoDatabaseTable","base:Strings","base:Types","base:Objs","base:Promise","base:Net.Uri"],function(a,b,c,d,e,f,g,h){return a.extend({scoped:h},function(a){return{constructor:function(b){d.is_string(b)?(this.__dbUri=c.strip_start(b,"mongodb://"),this.__dbObject=this.cls.uriToObject(b)):(b=e.extend({database:"database",server:"localhost",port:27017},b),this.__dbObject=b,this.__dbUri=this.cls.objectToUri(b)),a.constructor.call(this),this.mongo_module=require("mongodb")},_tableClass:function(){return b},mongo_object_id:function(a){return this.mongo_module.ObjectID},mongodb:function(){if(this.__mongodb)return f.value(this.__mongodb);var a=f.create();return this.mongo_module.MongoClient.connect("mongodb://"+this.__dbUri,{server:{auto_reconnect:!0}},a.asyncCallbackFunc()),a.success(function(a){this.__mongodb=a},this)}}},{uriToObject:function(a){var b=g.parse(a);return{database:c.strip_start(b.path,"/"),server:b.host,port:b.port,username:b.user,password:b.password}},objectToUri:function(a){return a.path=a.database,g.build(a)}})}),a.define("module:Databases.MongoDatabaseTable",["module:Databases.DatabaseTable","base:Promise","base:Objs","base:Types","base:Iterators.ArrayIterator"],function(a,b,c,d,e,f){return a.extend({scoped:f},{table:function(){return this.__table?b.create(this.__table):this._database.mongodb().mapSuccess(function(a){return this.__table=a.collection(this._table_name),this.__table},this)},_encode:function(a){var b=c.clone(a,1);if("id"in a&&(delete b.id,null!==a.id)){var e=this._database.mongo_object_id();b._id=d.is_object(a.id)?a.id:new e(a.id+"")}return b},_decode:function(a){var b=c.clone(a,1);return"_id"in a&&(delete b._id,b.id=a._id),b},_find:function(a,c){return this.table().mapSuccess(function(d){return b.funcCallback(d,d.find,a).mapSuccess(function(a){return c=c||{},"sort"in c&&(a=a.sort(c.sort)),"skip"in c&&(a=a.skip(c.skip)),"limit"in c&&(a=a.limit(c.limit)),b.funcCallback(a,a.toArray).mapSuccess(function(a){return new e(a)},this)},this)},this)},_count:function(a){return this.table().mapSuccess(function(c){return b.funcCallback(c,c.find,a).mapSuccess(function(a){return b.funcCallback(a,a.count)})})},_insertRow:function(a){return this.table().mapSuccess(function(c){return b.funcCallback(c,c.insert,a).mapSuccess(function(b){return a},this)},this)},_removeRow:function(a,c){return this.table().mapSuccess(function(c){return b.funcCallback(c,c.remove,a)},this)},_updateRow:function(a,c,d){return this.table().mapSuccess(function(d){return b.funcCallback(d,d.update,a,{$set:c}).mapSuccess(function(){return c})},this)},ensureIndex:function(a){var b={};b[a]=1,this.table().success(function(b){b.ensureIndex(c.objectBy(a,1))})}})}),a.define("module:Net.ControllerException",["base:Exceptions.Exception","base:Net.HttpHeader"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(c,d){d=d||{},this.__data=d,this.__code=c,a.constructor.call(this,b.format(c,!0))},code:function(){return this.__code},data:function(){return this.__data}}})}),a.define("module:Net.Controller",["base:Class","base:Promise","base:Types","module:Net.ControllerException"],function(a,b,c,d,e){return a.extend({scoped:e},{},{_beforeDispatch:function(a,c,d){return b.create(!0)},_dispatch:function(a,b,c){return this[a](b,c)},dispatch:function(a,e,f,g){this._beforeDispatch(a,e,f).success(function(){var h=this._dispatch(a,e,f);h=b.is(h)?h:b.create(!0),h.success(function(){c.is_defined(g)&&g()}).error(function(a){a=d.ensure(a),f.status(a.code()).send(JSON.stringify(a.data()))})},this).error(function(a){a=d.ensure(a),f.status(a.code()).send(JSON.stringify(a.data()))})}})}),a.define("module:Net.SessionControllerMixin",function(){return{_obtainSession:function(a,b,c,d,e){return a.obtain_session(d.cookies[b]).mapSuccess(function(c){return d.session=c,e.cookie(b,c.cid(),{maxAge:a.options().invalidation.session_timeout}),c})}}}),a.define("module:Sessions.ActiveSessionHelper",["base:Class","base:Classes.HelperClassMixin","base:Lists.ObjectIdList","base:Tokens"],function(a,b,c,d,e){return a.extend({scoped:e},[b,function(a){return{constructor:function(b,d){a.constructor.call(this),this.__helper=d,this.__session=b,b.active_sessions=this,this.__active_sessions=new c},destroy:function(){this.iterate(function(a){a.destroy()},this),this.__active_sessions.destroy(),a.destroy.call(this)},session:function(){return this.__session},helper:function(){return this.__helper},invalidate:function(){this.iterate(function(a){a.invalidate()},this)},iterate:function(a,b){this.__active_sessions.iterate(a,b||this)},is_active:function(){return this.__active_sessions.count()>0},find_active_session:function(a){return this.__active_sessions.get(a)},__generate_token:function(){return d.generate_token()},__remove_active_session:function(a){this.__active_sessions.exists(a)&&(this.__active_sessions.remove(a),this.__session.activity())},delete_active_session:function(a){a.destroy()},obtain_active_session:function(a,b){return this.find_active_session(a)||this.new_active_session(a,b)},__add_active_session:function(a){this.__active_sessions.add(a),this.session().manager().__add_active_session(this.session(),a)},new_active_session:function(a,b){var c=new this.__helper._active_session_class(this,a||this.__generate_token(),b);return this.__add_active_session(c),c},continue_active_session:function(a){var b=null;return this.iterate(function(c){return c.suspended()&&c.can_continue(a)?(b=c,!1):!0}),b},attach_active_session:function(a){return this.continue_active_session(a)||this.new_active_session(null,a)}}}])}),a.define("module:Sessions.ActiveSession",["base:Class","base:Classes.HelperClassMixin","base:Events.EventsMixin","base:Ids","base:Time"],function(a,b,c,d,e,f){return a.extend({scoped:f},[b,c,function(a){return{constructor:function(b,c,f){a.constructor.call(this),this.__helper=b,this.__options=f||{},d.objectId(this,c),this.initiation_time=e.now(),this.active_time=this.initiation_time},destroy:function(){this.trigger("destroy"),this.__helper.__remove_active_session(this),a.destroy.call(this)},session:function(){return this.__helper.session()},options:function(){return this.__options},activity:function(){this.active_time=e.now()},suspended:function(){return this._helper({method:"suspended",fold_start:!1,fold:function(a,b){return a||b}})},can_continue:function(a){return!1},invalidate:function(){var a=this.__helper.helper().options().invalidation,b=e.now();(a.active_session_timeout&&b>this.initiation_time+a.active_session_timeout||this.suspended()&&a.active_session_inactivity_timeout&&b>this.active_time+a.active_session_inactivity_timeout)&&this.destroy()}}}])}),a.define("module:Sessions.ActiveSessionManagerHelper",["base:Class","module:Sessions.ActiveSession","module:Sessions.ActiveSessionHelper","base:Objs","base:Types"],function(b,c,d,e,f,g){return b.extend({scoped:g},function(b){return{_active_session_class:c,constructor:function(c,d){b.constructor.call(this),d=e.tree_extend({invalidation:{active_session_timeout:36e5,active_session_inactivity_timeout:6e4}},d),this.__options=d,this._active_session_class=d.active_session_class||this._active_session_class,f.is_string(this._active_session_class)&&(this._active_session_class=a.getGlobal(this._active_session_class)),c.__add_active_session=function(a,b){this._helper("__add_active_session",a,b)}},__add_session:function(a){a.addHelper(d,this)},options:function(){return this.__options}}})}),a.define("module:Sessions.PersistentSessionModel",["data:Modelling.Model"],function(a,b){return a.extend({scoped:b},{},function(a){return{_initializeScheme:function(){var b=a._initializeScheme.call(this);return b.token={type:"string",index:!0},b.created={type:"date",index:!0},b}}})}),a.define("module:Sessions.PersistentSessionManagerHelper",["base:Class","module:Sessions.PersistentSessionModel","base:Objs","base:Types","data:Stores.MemoryStore","data:Modelling.Table","base:Timers.Timer","base:Time"],function(b,c,d,e,f,g,h,i,j){return b.extend({scoped:j},function(b){return{_persistent_session_model:c,constructor:function(c,i){b.constructor.call(this),this.__manager=c,i=d.tree_extend({invalidation:{session_timeout:31536e6,timer:864e5}},i),this.__options=i,this.__store=i.store?i.store:this._auto_destroy(new f),this._persistent_session_model=i.persistent_session_model||this._persistent_session_model,e.is_string(this._persistent_session_model)&&(this._persistent_session_model=a.getGlobal(this._persistent_session_model)),i.invalidation.timer&&(this.__timer=this._auto_destroy(new h({fire:this.invalidate,context:this,delay:i.invalidation.timer}))),this._persistent_session_model.table||(this._persistent_session_model.table=this._auto_destroy(new g(this.__store,this._persistent_session_model))),this.__table=this._persistent_session_model.table,c.table=this.__table,c.store=this.__store},__lookup_session:function(a){return this.__table.findBy({token:a}).mapCallback(function(b,c){return c&&!b?this.__manager.new_session(a,{model:c}):null},this)},__add_session:function(a){var b=a.options();b.model||(b.model=this.__table.newModel({token:a.cid(),created:i.now()}),b.model.save()),a.model=b.model,a.model.session=a},options:function(){return this.__options},invalidate:function(){if(this.__options.invalidation.session_timeout){var a=i.now()-this.__options.invalidation.session_timeout;this.__table.allBy({created:{$lt:a}}).success(function(a){for(;a.hasNext();){var b=a.next();b.session&&this.__manager.delete_session(b.session),b.remove()}},this)}}}})}),a.define("module:Sessions.RMIHelper",["base:Class","base:Channels.ReadySender","base:Net.SocketSenderChannel","base:Net.SocketReceiverChannel","base:RMI.Peer"],function(a,b,c,d,e,f){return a.extend({scoped:f},function(a){return{constructor:function(f){a.constructor.call(this),this.__active_session=f,f.rmi=this,this.__rmi_sender=new b(new c(null,"rmi")),this.__rmi_receiver=new d(null,"rmi"),this.__rmi_peer=new e(this.__rmi_sender,this.__rmi_receiver),f.rmi_peer=this.__rmi_peer,this.stubs={},this.skeletons={},f.stubs=this.stubs,f.skeletons=this.skeletons,f.on("bind_socket",function(a){this.__rmi_receiver.socket(a),this.__rmi_sender.socket(a),this.__rmi_sender.ready()},this),f.on("unbind_socket",function(){this.__rmi_sender.unready()},this),"initialize_rmi"in f&&f.initialize_rmi()},destroy:function(){for(var b in this.stubs)this.stubs[b].destroy();for(b in this.skeletons)this.skeletons[b].destroy();this.__rmi_peer.destroy(),this.__rmi_receiver.destroy(),this.__rmi_sender.destroy(),a.destroy.call(this)}}})}),a.define("module:Sessions.RMIManagerHelper",["base:Class","module:Sessions.RMIHelper"],function(a,b,c){return a.extend({scoped:c},{__add_active_session:function(a,c){c.addHelper(b)}})}),a.define("module:Sessions.Session",["base:Class","base:Classes.HelperClassMixin","base:Ids","base:Time"],function(a,b,c,d,e){return a.extend({scoped:e},[b,function(a){return{constructor:function(b,e,f){a.constructor.call(this),this.__manager=b,this.__options=f||{},c.objectId(this,e),this.initiation_time=d.now(),this.active_time=this.initiation_time},destroy:function(){this.__manager.__remove_session(this),a.destroy.call(this)},is_active:function(){return this._helper({method:"is_active",fold_start:!1,fold:function(a,b){return a||b}})},activity:function(){this.active_time=d.now()},invalidate:function(){this._helper("invalidate");var a=this.__manager.options().invalidation,b=d.now();(a.session_timeout&&b>this.initiation_time+a.session_timeout||!this.is_active()&&a.session_inactivity_timeout&&b>this.active_time+a.session_inactivity_timeout)&&this.destroy()},manager:function(){return this.__manager},options:function(){return this.__options}}}])}),a.define("module:Sessions.Manager",["base:Class","base:Events.EventsMixin","base:Classes.HelperClassMixin","module:Sessions.Session","base:Objs","base:Types","base:Timers.Timer","base:Lists.ObjectIdList","base:Tokens","base:Promise"],function(b,c,d,e,f,g,h,i,j,k,l){return b.extend({scoped:l},[c,d,function(b){return{_session_class:e,constructor:function(c){b.constructor.call(this),c=f.tree_extend({invalidation:{session_timeout:864e5,session_inactivity_timeout:36e5,timer:6e4}},c),this.__options=c,this._session_class=c.session_class||this._session_class,g.is_string(this._session_class)&&(this._session_class=a.getGlobal(this._session_class)),c.invalidation.timer&&(this.__timer=this._auto_destroy(new h({fire:this.invalidate,context:this,delay:c.invalidation.timer}))),this.__sessions=new i},destroy:function(){this.iterate(function(a){a.destroy()}),this.__sessions.destroy(),b.destroy.call(this)},iterate:function(a,b){this.__sessions.iterate(a,b||this)},obtain_session:function(a,b){return this.find_session(a).mapSuccess(function(c){return c||this.new_session(a,b)},this)},__generate_token:function(){return j.generate_token()},__lookup_session:function(a){return this._helper({method:"__lookup_session",async:!0},a)},find_session:function(a){if(!a)return k.value(null);var b=this.__sessions.get(a);return b?k.create(b):this.__lookup_session(a)},__add_session:function(a){this.__sessions.add(a),this._helper("__add_session",a)},new_session:function(a,b){var c=new this._session_class(this,a||this.__generate_token(),b);return this.__add_session(c),c},invalidate:function(){this.iterate(function(a){a.invalidate()})},options:function(){return this.__options},__remove_session:function(a){this.__sessions.exists(a)&&(this._helper("remove_session",a),this.__sessions.remove(a))},delete_session:function(a){a.destroy()}}}])}),a.define("module:Sessions.SocketsHelper",["base:Class"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b){a.constructor.call(this),this.__active_session=b,b.socket=this},destroy:function(){this.unbind(),a.destroy.call(this)},suspended:function(){return!this.socket()},bind:function(a){if(a!=this.__socket){this.unbind(),this.__socket=a;var b=this;a.on("disconnect",function(){b.unbind()}),this.__active_session.trigger("bind_socket",a)}},unbind:function(){this.__socket&&(this.__socket=null,this.__active_session.activity(),this.__active_session.trigger("unbind_socket"),this.__active_session.session().manager().sockets_manager_helper.__options.remove_on_disconnect&&this.__active_session.destroy())},socket:function(){return this.__socket}}})}),a.define("module:Sessions.SocketsManagerHelper",["base:Class","base:Objs","base:Strings","module:Sessions.SocketsHelper"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{constructor:function(d,e){a.constructor.call(this),this.__manager=d,d.sockets_manager_helper=this,this.__options=b.extend({remove_on_disconnect:!1},e),d.bind_socket=function(a,b,d){var e=c.read_cookie_string(a.handshake.headers.cookie,b,d);this.find_session(e).success(function(b){if(!b)return void a.disconnect();var c=b.active_sessions.find_active_session(d.active_session_token);return c?void c.socket.bind(a):void a.disconnect()},this)}},__add_active_session:function(a,b){b.addHelper(d)}}})}),a.define("module:Stores.DatabaseStore",["data:Stores.BaseStore","base:Objs","data:Queries","data:Queries.Constrained"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{constructor:function(b,c,d){a.constructor.call(this),this.__database=b,this.__table_name=c,this.__table=null,this.__foreign_id=d},table:function(){return this.__table||(this.__table=this.__database.getTable(this.__table_name)),this.__table},_insert:function(a){return this.__foreign_id&&a[this.__foreign_id]?this.table().findOne(b.objectBy(this.__foreign_id,a[this.__foreign_id])).mapSuccess(function(b){return b?b:this.table().insertRow(a)},this):this.table().insertRow(a)},_remove:function(a){return this.__foreign_id?this.table().removeRow(b.objectBy(this.__foreign_id,a)):this.table().removeById(a)},_get:function(a){return this.__foreign_id?this.table().findOne(b.objectBy(this.__foreign_id,a)):this.table().findById(a)},_update:function(a,c){return this.__foreign_id?this.updateRow(b.objectBy(this.__foreign_id,a),c):this.table().updateById(a,c)},_query_capabilities:function(){return d.fullConstrainedQueryCapabilities(c.fullQueryCapabilities())},_query:function(a,b){return this.table().find(a,b)},_ensure_index:function(a){this.table().ensureIndex(a)}}})}),a.define("module:Stores.Migrator",["base:Class","base:Types"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(){a.constructor.call(this),this.__version=null,this.__migrations=[],this.__sorted=!0},version:function(a){return this.__version||(this.__version=this._getVersion()),this.__version},_getVersion:function(){},_setVersion:function(a){},_log:function(a){},migrations:function(){return this.__sorted||(this.__migrations.sort(function(a,b){return a.version-b.version}),this.__sorted=!0),this.__migrations},register:function(a){this.__migrations.push(a),this.__sorted=!1},_indexByVersion:function(a){for(var b=0;b<this.__migrations.length;++b){if(a==this.__migrations[b].version)return b;if(a<this.__migrations[b].version)return b-1}return this.__migrations.length},migrate:function(a){for(var c=this._indexByVersion(this.version()),d=b.is_defined(a)?this._indexByVersion(a):this.__migrations.length-1;d>c;){var e=this.__migrations[c+1];this._log("Migrate "+e.version+": "+e.title+" - "+e.description+"...\n");try{e.migrate(),this._setVersion(this.__migrations[c+1].version),c++,this._log("Successfully migrated "+e.version+".\n")}catch(f){this._log("Failure! Rolling back "+e.version+"...\n");try{if("partial_rollback"in e)e.partial_rollback();else{if(!("rollback"in e))throw"No rollback defined";e.rollback()}}catch(g){throw this._log("Failure! Couldn't roll back "+e.version+"!\n"),g}throw this._log("Rolled back "+e.version+"!\n"),f}}},rollback:function(a){for(var c=this._indexByVersion(this.version()),d=b.is_defined(a)?this._indexByVersion(a):c-1;c>d;){var e=this.__migrations[c];this._log("Rollback "+e.version+": "+e.title+" - "+e.description+"...\n");try{e.rollback(),this._setVersion(c>=1?this.__migrations[c-1].version:0),c--,this._log("Successfully rolled back "+e.version+".\n")}catch(f){throw this._log("Failure! Couldn't roll back "+e.version+"!\n"),f}}}}})}),a.define("module:Stores.MongoDatabaseStore",["data:Stores.TransformationStore","base:Objs","module:Stores.DatabaseStore"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(b,d,e,f){var g=new c(b,d,f);this._types=e||{},f||(this._types.id="id"),this._foreign_id=f,this._ObjectId=b.mongo_object_id(),a.constructor.call(this,g)},table:function(){return this.store().table()},_encodeSort:function(a){var c={};return b.iter(a,function(a,b){"id"===b&&(b="_id"),c[b]=a}),c},_encodeData:function(a){var c=b.map(a,function(a,b){return"id"===this._types[b]?a?new this._ObjectId(a+""):null:a},this);return this._foreign_id&&(c.id=c[this._foreign_id],delete c[this._foreign_id]),c},_decodeData:function(a){var c=b.map(a,function(a,b){return"id"===this._types[b]?a?a+"":null:a},this);return this._foreign_id&&(c[this._foreign_id]=c.id,delete c.id),c}}})})}).call(Scoped);