/*!
betajs-server - v1.0.0 - 2014-12-07
Copyright (c) Oliver Friedmann
MIT Software License.
*/
BetaJS.Net.AbstractAjax.extend("BetaJS.Server.Net.HttpAjax",{_syncCall:function(){throw"Unsupported"},_asyncCall:function(a,b){var c=BetaJS.Net.Uri.parse(a.uri),d={method:a.method,host:c.host,port:c.port,path:c.path},e=null;a.data&&("GET"==d.method?d.path=d.path+"?"+this.cls.querystring().stringify(a.data):(e=this.cls.querystring().stringify(a.data),e.length>0&&(d.headers={"Content-Type":"application/x-www-form-urlencoded","Content-Length":e.length})));var f=this.cls.http().request(d,function(a){var c="";a.on("data",function(a){c+=a}).on("end",function(){a.statusCode>=200&&a.statusCode<300?BetaJS.SyncAsync.callback(b,"success",c):BetaJS.SyncAsync.callback(b,"exception",c)})});e&&e.length>0&&f.write(e),f.end()}},{__http:null,http:function(){return this.__http||(this.__http=require("http")),this.__http},__querystring:null,querystring:function(){return this.__querystring||(this.__querystring=require("querystring")),this.__querystring}}),BetaJS.Class.extend("BetaJS.Server.Net.Controller",{},{_beforeDispatch:function(){return BetaJS.Promise.create(!0)},dispatch:function(a,b,c,d){this._beforeDispatch(a,b,c).success(function(){var e=this[a](b,c);e=BetaJS.Promise.is(e)?e:BetaJS.Promise.create(!0),e.success(function(){BetaJS.Types.is_defined(d)&&d()}).error(function(a){a=BetaJS.Server.Net.ControllerException.ensure(a),c.status(a.code()).send(JSON.stringify(a.data()))})},this).error(function(a){a=BetaJS.Server.Net.ControllerException.ensure(a),c.status(a.code()).send(JSON.stringify(a.data()))})}}),BetaJS.Exceptions.Exception.extend("BetaJS.Server.Net.ControllerException",{constructor:function(a,b){b=b||{},this.__data=b,this.__code=a,this._inherited(BetaJS.Server.Net.ControllerException,"constructor",BetaJS.Net.HttpHeader.format(a,!0))},code:function(){return this.__code},data:function(){return this.__data}}),BetaJS.Server.Net.SessionControllerMixin={_obtainSession:function(a,b,c,d,e){return a.obtain_session(d.cookies[b]).mapSuccess(function(c){return d.session=c,e.cookie(b,c.cid(),{maxAge:a.options().invalidation.session_timeout}),c})}},BetaJS.Class.extend("BetaJS.Server.Net.Imap",[BetaJS.Events.EventsMixin,{constructor:function(a,b){this._inherited(BetaJS.Server.Net.Imap,"constructor"),this.__quoted_printable=require("quoted-printable"),this.__html_strip=require("htmlstrip-native"),this.__auth=a,b=b||{},this.__options=b,this.__count=0,this.__Imap=require("imap"),this.__connected=!1,this.__imap=new this.__Imap(BetaJS.Objs.extend({tls:!0,tlsOptions:{rejectUnauthorized:!1}},a));var c=this;this.__imap.on("mail",function(a){c.__count+=a}),this.__imap.on("error",function(){c.trigger("error"),b.reconnect_on_error&&BetaJS.SyncAsync.eventually(c.reconnect,[],c)})},destroy:function(){this.disconnect(),this._inherited(BetaJS.Server.Net.Imap,"destroy")},connect:function(){if(this.__connected)return BetaJS.Promise.value(!0);this.__count=0;var a=this,b=BetaJS.Promise.create(),c=function(){b.error(!0),a.off("error",c)};return this.on("error",c),this.__imap.connect(),this.__imap.once("ready",function(){a.__connected=!0;var d=a.__options.mailbox||"INBOX";BetaJS.Types.is_array(d)||(d=[d]),d=BetaJS.Objs.clone(d,1);var e=null,f=function(){0===d.length&&(b.error(e),a.__connected=!1);var g=d.shift();a.__imap.openBox(g,!0,function(d){return d?(e=d,void f()):(a.on("error",c),a.__imap.on("mail",function(b){a.trigger("new_mail",b)}),void b.asyncSuccess(!0))})};a.off("error",c),f()}),b},disconnect:function(){this.__connected&&(this.__imap.end(),this.__connected=!1)},reconnect:function(){this.disconnect(),this.connect()},count:function(){return this.__count},fetch:function(a){a=a||{};var b=[];"headers"in a&&!a.headers||b.push("HEADER.FIELDS (FROM TO SUBJECT DATE)"),"body"in a&&!a.body||b.push("TEXT");var c=1,d=100;if(a.seq_count?a.seq_end?(d=a.seq_end,c=d-a.seq_count+1):(c=a.seq_start||c,d=c+a.seq_count-1):(c=a.seq_start||c,d=a.seq_end||c+99),a.reverse){var e=d-c;d=this.__count-c+1,c=d-e}var f=this.__imap.seq.fetch(c+":"+d,{bodies:b,struct:!0});return this.__query(f)},__query:function(a){var b=this,c=[];a.on("message",function(a,d){var e={},f="",g="";a.on("body",function(a,b){a.on("data",function(a){"TEXT"===b.which?g+=a.toString("utf8"):f+=a.toString("utf8")})}),a.once("attributes",function(a){e=a}),a.once("end",function(){e.seqno=d;try{var a=b.__parse(b.__Imap.parseHeader(f),g,e);a&&c.push(a)}catch(h){}})});var d=BetaJS.Promise.create();return a.once("error",function(a){d.asyncError(a)}),a.once("end",function(){d.asyncSuccess(c)}),d},__parse:function(a,b,c){this.trigger("parse",a,b,c);var d={};if(d.uid=c.uid,d.threadid=c["x-gm-thrid"],d.id=c.uid,d.seqid=c.seqno,a&&a.subject&&a.subject.length>0&&(d.subject=a.subject[0]),a&&a.to&&a.to.length>0&&(d.to=a.to[0]),a&&a.from&&a.from.length>0&&(d.from=a.from[0]),a&&a.date&&a.date.length>0){var e=new Date(a.date[0]);d.date=e.getTime()}if(b){var f=c.struct,g=[];if(f.length>1)for(var h=f[0].params.boundary,i=b,j=i.indexOf(h),k=1;k<f.length;++k){var l=f[k][0]||{};if(i=i.substring(i.indexOf(h)+h.length),i=i.substring(i.indexOf("\r\n\r\n")+"\r\n\r\n".length),!l.disposition&&"text"==l.type){var m=i.indexOf(h)-j;g.push({meta:l,body:m>=0?i.substring(0,m):i})}}else g.push({meta:f[0],body:b});for(var n=null,o=null,p=0;p<g.length;++p){var q=g[p].body,r=g[p].meta.encoding.toLowerCase();try{q="quoted-printable"==r?this.__quoted_printable.decode(q).toString():new Buffer(q,r).toString()}catch(s){}"html"==g[p].meta.subtype?n=q:o=q}!o&&n&&(o=this.__html_strip.html_strip(n,{include_script:!1,include_style:!1,compact_whitespace:!0})),d.html_body=n,d.text_body=o}return d}}]),BetaJS.Server.Net.Smtp={send:function(a,b){var c=require("emailjs");b.from=BetaJS.Strings.email_get_email(b.from),b.to=BetaJS.Strings.email_get_email(b.to),b.text_body&&(b.text=b.text_body,delete b.text_body);var d=BetaJS.Promise.create();return c.server.connect(a).send(c.message.create(b),d.asyncCallbackFunc()),d}},BetaJS.Class.extend("BetaJS.Server.Sessions.Manager",[BetaJS.Events.EventsMixin,BetaJS.Classes.HelperClassMixin,{_session_class:"BetaJS.Server.Sessions.Session",constructor:function(a){this._inherited(BetaJS.Server.Sessions.Manager,"constructor"),a=BetaJS.Objs.tree_extend({invalidation:{session_timeout:864e5,session_inactivity_timeout:36e5,timer:6e4}},a),this.__options=a,this._session_class=a.session_class||this._session_class,BetaJS.Types.is_string(this._session_class)&&(this._session_class=BetaJS.Scopes.resolve(this._session_class)),a.invalidation.timer&&(this.__timer=this._auto_destroy(new BetaJS.Timers.Timer({fire:this.invalidate,context:this,delay:a.invalidation.timer}))),this.__sessions=new BetaJS.Lists.ObjectIdList},destroy:function(){this.iterate(function(a){a.destroy()}),this.__sessions.destroy(),this._inherited(BetaJS.Server.Sessions.Manager,"destroy")},iterate:function(a,b){this.__sessions.iterate(a,b||this)},obtain_session:function(a,b){return this.find_session(a).mapSuccess(function(c){return c||this.new_session(a,b)},this)},__generate_token:function(){return BetaJS.Tokens.generate_token()},__lookup_session:function(a){return this._helper({method:"__lookup_session",async:!0},a)},find_session:function(a){var b=this.__sessions.get(a);return b?BetaJS.Promise.create(b):this.__lookup_session(a)},__add_session:function(a){this.__sessions.add(a),this._helper("__add_session",a)},new_session:function(a,b){var c=new this._session_class(this,a||this.__generate_token(),b);return this.__add_session(c),c},invalidate:function(){this.iterate(function(a){a.invalidate()})},options:function(){return this.__options},__remove_session:function(a){this.__sessions.exists(a)&&(this._helper("remove_session",a),this.__sessions.remove(a))},delete_session:function(a){a.destroy()}}]),BetaJS.Class.extend("BetaJS.Server.Sessions.Session",[BetaJS.Classes.HelperClassMixin,{constructor:function(a,b,c){this._inherited(BetaJS.Server.Sessions.Session,"constructor"),this.__manager=a,this.__options=c||{},BetaJS.Ids.objectId(this,b),this.initiation_time=BetaJS.Time.now(),this.active_time=this.initiation_time},destroy:function(){this.__manager.__remove_session(this),this._inherited(BetaJS.Server.Sessions.Session,"destroy")},is_active:function(){return this._helper({method:"is_active",fold_start:!1,fold:function(a,b){return a||b}})},activity:function(){this.active_time=BetaJS.Time.now()},invalidate:function(){this._helper("invalidate");var a=this.__manager.options().invalidation,b=BetaJS.Time.now();(a.session_timeout&&b>this.initiation_time+a.session_timeout||!this.is_active()&&a.session_inactivity_timeout&&b>this.active_time+a.session_inactivity_timeout)&&this.destroy()},manager:function(){return this.__manager},options:function(){return this.__options}}]),BetaJS.Class.extend("BetaJS.Server.Session.ActiveSessionManagerHelper",{_active_session_class:"BetaJS.Server.Sessions.ActiveSession",constructor:function(a,b){this._inherited(BetaJS.Server.Session.ActiveSessionManagerHelper,"constructor"),b=BetaJS.Objs.tree_extend({invalidation:{active_session_timeout:36e5,active_session_inactivity_timeout:6e4}},b),this.__options=b,this._active_session_class=b.active_session_class||this._active_session_class,BetaJS.Types.is_string(this._active_session_class)&&(this._active_session_class=BetaJS.Scopes.resolve(this._active_session_class)),a.__add_active_session=function(a,b){this._helper("__add_active_session",a,b)}},__add_session:function(a){a.addHelper(BetaJS.Server.Session.ActiveSessionHelper,this)},options:function(){return this.__options}}),BetaJS.Class.extend("BetaJS.Server.Session.ActiveSessionHelper",[BetaJS.Classes.HelperClassMixin,{constructor:function(a,b){this._inherited(BetaJS.Server.Session.ActiveSessionHelper,"constructor"),this.__helper=b,this.__session=a,a.active_sessions=this,this.__active_sessions=new BetaJS.Lists.ObjectIdList},destroy:function(){this.iterate(function(a){a.destroy()},this),this.__active_sessions.destroy(),this._inherited(BetaJS.Server.Session.ActiveSessionHelper,"destroy")},session:function(){return this.__session},helper:function(){return this.__helper},invalidate:function(){this.iterate(function(a){a.invalidate()},this)},iterate:function(a,b){this.__active_sessions.iterate(a,b||this)},is_active:function(){return this.__active_sessions.count()>0},find_active_session:function(a){return this.__active_sessions.get(a)},__generate_token:function(){return BetaJS.Tokens.generate_token()},__remove_active_session:function(a){this.__active_sessions.exists(a)&&(this.__active_sessions.remove(a),this.__session.activity())},delete_active_session:function(a){a.destroy()},obtain_active_session:function(a,b){return this.find_active_session(a)||this.new_active_session(a,b)},__add_active_session:function(a){this.__active_sessions.add(a),this.session().manager().__add_active_session(this.session(),a)},new_active_session:function(a,b){return active_session=new this.__helper._active_session_class(this,a||this.__generate_token(),b),this.__add_active_session(active_session),active_session},continue_active_session:function(a){var b=null;return this.iterate(function(c){return c.suspended()&&c.can_continue(a)?(b=c,!1):!0}),b},attach_active_session:function(a){return this.continue_active_session(a)||this.new_active_session(null,a)}}]),BetaJS.Class.extend("BetaJS.Server.Sessions.ActiveSession",[BetaJS.Classes.HelperClassMixin,BetaJS.Events.EventsMixin,{constructor:function(a,b,c){this._inherited(BetaJS.Server.Sessions.ActiveSession,"constructor"),this.__helper=a,this.__options=c||{},BetaJS.Ids.objectId(this,b),this.initiation_time=BetaJS.Time.now(),this.active_time=this.initiation_time},destroy:function(){this.trigger("destroy"),this.__helper.__remove_active_session(this),this._inherited(BetaJS.Server.Sessions.ActiveSession,"destroy")},options:function(){return this.__options},activity:function(){this.active_time=BetaJS.Time.now()},suspended:function(){return this._helper({method:"suspended",fold_start:!1,fold:function(a,b){return a||b}})},can_continue:function(){return!1},invalidate:function(){var a=this.__helper.helper().options().invalidation,b=BetaJS.Time.now();(a.active_session_timeout&&b>this.initiation_time+a.active_session_timeout||this.suspended()&&a.active_session_inactivity_timeout&&b>this.active_time+a.active_session_inactivity_timeout)&&this.destroy()}}]),BetaJS.Class.extend("BetaJS.Server.Session.PersistentSessionManagerHelper",{_persistent_session_model:"BetaJS.Server.Sessions.PersistentSessionModel",constructor:function(a,b){this._inherited(BetaJS.Server.Session.PersistentSessionManagerHelper,"constructor"),this.__manager=a,b=BetaJS.Objs.tree_extend({invalidation:{session_timeout:31536e6,timer:864e5}},b),this.__options=b,this.__store=b.store?b.store:this._auto_destroy(new BetaJS.Stores.MemoryStore),this._persistent_session_model=b.persistent_session_model||this._persistent_session_model,BetaJS.Types.is_string(this._persistent_session_model)&&(this._persistent_session_model=BetaJS.Scopes.resolve(this._persistent_session_model)),b.invalidation.timer&&(this.__timer=this._auto_destroy(new BetaJS.Timers.Timer({fire:this.invalidate,context:this,delay:b.invalidation.timer}))),this._persistent_session_model.table||(this._persistent_session_model.table=this._auto_destroy(new BetaJS.Modelling.Table(this.__store,this._persistent_session_model))),this.__table=this._persistent_session_model.table,a.table=this.__table,a.store=this.__store},__lookup_session:function(a){return this.__table.findBy({token:a}).mapCallback(function(b,c){return c&&!b?this.__manager.new_session(a,{model:c}):null},this)},__add_session:function(a){var b=a.options();b.model||(b.model=this.__table.newModel({token:a.cid(),created:BetaJS.Time.now()}),b.model.save()),a.model=b.model,a.model.session=a},options:function(){return this.__options},invalidate:function(){if(this.__options.invalidation.session_timeout){var a=BetaJS.Time.now()-this.__options.invalidation.session_timeout;this.__table.allBy({created:{$lt:a}}).success(function(a){for(;a.hasNext();){var b=a.next();b.session&&this.__manager.delete_session(b.session),b.remove()}},this)}}}),BetaJS.Modelling.Model.extend("BetaJS.Server.Sessions.PersistentSessionModel",{},{_initializeScheme:function(){var a=this._inherited(BetaJS.Server.Sessions.PersistentSessionModel,"_initializeScheme");return a.token={type:"string",index:!0},a.created={type:"date",index:!0},a}}),BetaJS.Class.extend("BetaJS.Server.Session.RMIManagerHelper",{__add_active_session:function(a,b){b.addHelper(BetaJS.Server.Session.RMIHelper)}}),BetaJS.Class.extend("BetaJS.Server.Session.RMIHelper",{constructor:function(a){this._inherited(BetaJS.Server.Session.RMIHelper,"constructor"),this.__active_session=a,a.rmi=this,this.__rmi_sender=new BetaJS.Net.SocketSenderChannel(null,"rmi",!1),this.__rmi_receiver=new BetaJS.Net.SocketReceiverChannel(null,"rmi"),this.__rmi_peer=new BetaJS.RMI.Peer(this.__rmi_sender,this.__rmi_receiver),a.rmi_peer=this.__rmi_peer,this.stubs={},this.skeletons={},a.stubs=this.stubs,a.skeletons=this.skeletons,a.on("bind_socket",function(a){this.__rmi_receiver.socket(a),this.__rmi_sender.socket(a),this.__rmi_sender.ready()},this),a.on("unbind_socket",function(){this.__rmi_sender.unready()},this),"initialize_rmi"in a&&a.initialize_rmi()},destroy:function(){for(var a in this.stubs)this.stubs[a].destroy;for(a in this.skeletons)this.skeletons[a].destroy;this.__rmi_peer.destroy(),this.__rmi_receiver.destroy(),this.__rmi_sender.destroy(),this._inherited(BetaJS.Server.Session.RMIHelper,"destroy")}}),BetaJS.Class.extend("BetaJS.Server.Session.SocketsManagerHelper",{constructor:function(a){this._inherited(BetaJS.Server.Session.SocketsManagerHelper,"constructor"),this.__manager=a,a.bind_socket=function(a,b,c){var d=BetaJS.Strings.read_cookie_string(a.handshake.headers.cookie,b,c);this.find_session(d).success(function(b){if(!b)return void a.disconnect();var d=b.active_sessions.find_active_session(c.active_session_token);return d?void d.socket.bind(a):void a.disconnect()},this)}},__add_active_session:function(a,b){b.addHelper(BetaJS.Server.Session.SocketsHelper)}}),BetaJS.Class.extend("BetaJS.Server.Session.SocketsHelper",{constructor:function(a){this._inherited(BetaJS.Server.Session.SocketsHelper,"constructor"),this.__active_session=a,a.socket=this},destroy:function(){this.unbind_socket(),this._inherited(BetaJS.Server.Session.SocketsHelper,"destroy")},suspended:function(){return!this.socket()},bind:function(a){if(a!=this.__socket){this.unbind(),this.__socket=a;var b=this;a.on("disconnect",function(){b.unbind()}),this.__active_session.trigger("bind_socket",a)}},unbind:function(){this.__socket=null,this.__active_session.activity(),this.__active_session.trigger("unbind_socket")},socket:function(){return this.__socket}}),BetaJS.Class.extend("BetaJS.Databases.Database",{_tableClass:function(){return null},getTable:function(a){var b=this._tableClass();return new b(this,a)}}),BetaJS.Class.extend("BetaJS.Databases.DatabaseTable",{constructor:function(a,b){this._inherited(BetaJS.Databases.DatabaseTable,"constructor"),this._database=a,this._table_name=b},findOne:function(a,b){return this._findOne(this._encode(a),b).mapSuccess(function(a){return a?this._decode(a):null},this)},_findOne:function(a,b){return b=b||{},b.limit=1,this._find(a,b).mapSuccess(function(a){return a.next()})},_encode:function(a){return a},_decode:function(a){return a},_find:function(){},find:function(a,b){return this._find(this._encode(a),b).mapSuccess(function(a){return new BetaJS.Iterators.MappedIterator(a,this._decode,this)},this)},findById:function(a){return this.findOne({id:a})},_insertRow:function(){},_removeRow:function(){},_updateRow:function(){},insertRow:function(a){return this._insertRow(this._encode(a)).mapSuccess(this._decode,this)},removeRow:function(a){return this._removeRow(this._encode(a))},updateRow:function(a,b){return this._updateRow(this._encode(a),this._encode(b)).mapSuccess(this._decode,this)},removeById:function(a){return this.removeRow({id:a})},updateById:function(a,b){return this.updateRow({id:a},b)},ensureIndex:function(){}}),BetaJS.Databases.Database.extend("BetaJS.Databases.MongoDatabase",{constructor:function(a){BetaJS.Types.is_string(a)?(this.__dbUri=BetaJS.Strings.strip_start(a,"mongodb://"),this.__dbObject=this.cls.uriToObject(a)):(a=BetaJS.Objs.extend({database:"database",server:"localhost",port:27017},a),this.__dbObject=a,this.__dbUri=this.cls.objectToUri(a)),this._inherited(BetaJS.Databases.MongoDatabase,"constructor"),this.mongo_module=require("mongodb")},_tableClass:function(){return BetaJS.Databases.MongoDatabaseTable},mongo_object_id:function(){return this.mongo_module.BSONNative.ObjectID},mongodb:function(){if(this.__mongodb)return BetaJS.Promise.value(this.__mongodb);var a=BetaJS.Promise.create();return this.mongo_module.MongoClient.connect("mongodb://"+this.__dbUri,{server:{auto_reconnect:!0}},a.asyncCallbackFunc()),a.success(function(a){this.__mongodb=a},this)},destroy:function(){this._inherited(BetaJS.Databases.MongoDatabase,"destroy")}},{uriToObject:function(a){var b=BetaJS.Net.Uri.parse(a);return{database:BetaJS.Strings.strip_start(b.path,"/"),server:b.host,port:b.port,username:b.user,password:b.password}},objectToUri:function(a){return a.path=a.database,BetaJS.Net.Uri.build(a)}}),BetaJS.Databases.DatabaseTable.extend("BetaJS.Databases.MongoDatabaseTable",{table:function(){return this.__table?BetaJS.Promise.create(this.__table):this._database.mongodb().mapSuccess(function(a){return this.__table=a.collection(this._table_name),this.__table},this)},_encode:function(a){var b=BetaJS.Objs.clone(a,1);if("id"in a){delete b.id;var c=this._database.mongo_object_id();b._id=new c(a.id+"")}return b},_decode:function(a){var b=BetaJS.Objs.clone(a,1);return"_id"in a&&(delete b._id,b.id=a._id),b},_find:function(a,b){return this.table().mapSuccess(function(c){return BetaJS.Promise.funcCallback(c,c.find,a).mapSuccess(function(a){return b=b||{},"sort"in b&&(a=a.sort(b.sort)),"skip"in b&&(a=a.skip(b.skip)),"limit"in b&&(a=a.limit(b.limit)),BetaJS.Promise.funcCallback(a,a.toArray).mapSuccess(function(a){return new BetaJS.Iterators.ArrayIterator(a)},this)},this)},this)},_insertRow:function(a){return this.table().mapSuccess(function(b){return BetaJS.Promise.funcCallback(b,b.insert,a).mapSuccess(function(a){return a[0]?a[0]:a},this)},this)},_removeRow:function(a){return this.table().mapSuccess(function(b){return BetaJS.Promise.funcCallback(b,b.remove,a)},this)},_updateRow:function(a,b){return this.table().mapSuccess(function(c){return BetaJS.Promise.funcCallback(c,c.update,a,{$set:b}).mapSuccess(function(){return b})},this)},ensureIndex:function(a){var b={};b[a]=1,this.table().success(function(b){b.ensureIndex(BetaJS.Objs.objectBy(a,1))})}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.DatabaseStore",{constructor:function(a,b,c){this._inherited(BetaJS.Stores.DatabaseStore,"constructor"),this.__database=a,this.__table_name=b,this.__table=null,this.__foreign_id=c},table:function(){return this.__table||(this.__table=this.__database.getTable(this.__table_name)),this.__table},_insert:function(a){return this.__foreign_id&&a[this.__foreign_id]?this.table().findOne(BetaJS.Objs.objectBy(this.__foreign_id,a[this.__foreign_id])).mapSuccess(function(b){return b?b:this.table().insertRow(a)},this):this.table().insertRow(a)},_remove:function(a){return this.__foreign_id?this.table().removeRow(BetaJS.Objs.objectBy(this.__foreign_id,a)):this.table().removeById(a)},_get:function(a){return this.__foreign_id?this.table().findOne(BetaJS.Objs.objectBy(this.__foreign_id,a)):this.table().findById(a)},_update:function(a,b){return this.__foreign_id?this.updateRow(BetaJS.Objs.objectBy(this.__foreign_id,a),b):this.table().updateById(a,b)},_query_capabilities:function(){return{query:!0,sort:!0,skip:!0,limit:!0}},_query:function(a,b){return this.table().find(a,b)},_ensure_index:function(a){this.table().ensureIndex(a)}}),BetaJS.Stores.ConversionStore.extend("BetaJS.Stores.MongoDatabaseStore",{constructor:function(a,b,c,d){var e=new BetaJS.Stores.DatabaseStore(a,b,d),f={},g={};c=c||{};var h=a.mongo_object_id();d||(c.id="id");for(var i in c)"id"==c[i]&&(f[i]=function(a){return a?new h(a+""):null},g[i]=function(a){return a?a+"":null});var j={value_encoding:f,value_decoding:g};d&&(j.key_encoding={id:d},j.key_encoding[d]=null,j.key_decoding={id:null},j.key_encoding[d]="id"),this._inherited(BetaJS.Stores.MongoDatabaseStore,"constructor",e,j)},table:function(){return this.store().table()}}),BetaJS.Class.extend("BetaJS.Stores.Migrator",{constructor:function(){this._inherited(BetaJS.Stores.Migrator,"constructor"),this.__version=null,this.__migrations=[],this.__sorted=!0},version:function(){return this.__version||(this.__version=this._getVersion()),this.__version},_getVersion:function(){},_setVersion:function(){},_log:function(){},migrations:function(){return this.__sorted||(this.__migrations.sort(function(a,b){return a.version-b.version}),this.__sorted=!0),this.__migrations},register:function(a){this.__migrations.push(a),this.__sorted=!1},_indexByVersion:function(a){for(var b=0;b<this.__migrations.length;++b){if(a==this.__migrations[b].version)return b;if(a<this.__migrations[b].version)return b-1}return this.__migrations.length},migrate:function(a){for(var b=this._indexByVersion(this.version()),c=BetaJS.Types.is_defined(a)?this._indexByVersion(a):this.__migrations.length-1;c>b;){var d=this.__migrations[b+1];this._log("Migrate "+d.version+": "+d.title+" - "+d.description+"...\n");try{d.migrate(),this._setVersion(this.__migrations[b+1].version),b++,this._log("Successfully migrated "+d.version+".\n")}catch(e){this._log("Failure! Rolling back "+d.version+"...\n");try{d.partial_rollback()}catch(e){throw this._log("Failure! Couldn't roll back "+d.version+"!\n"),e}throw this._log("Rolled back "+d.version+"!\n"),e}}},rollback:function(a){for(var b=this._indexByVersion(this.version()),c=BetaJS.Types.is_defined(a)?this._indexByVersion(c):-1;b>c;){var d=this.__migrations[b];this._log("Rollback "+d.version+": "+d.title+" - "+d.description+"...\n");try{d.rollback(),this._setVersion(b>=1?this.__migrations[b-1].version:0),b--,this._log("Successfully rolled back "+d.version+".\n")}catch(e){throw this._log("Failure! Couldn't roll back "+d.version+"!\n"),e}}}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.ImapStore",{constructor:function(a){this._inherited(BetaJS.Stores.ImapStore,"constructor",a),this.__imap=BetaJS.Objs.extend(BetaJS.Objs.clone(a.base,1),a.imap),this.__smtp=BetaJS.Objs.extend(BetaJS.Objs.clone(a.base,1),a.smtp),this.__imap_opts=a.imap_options||{},this.__imap_opts.reconnect_on_error=!1},test:function(){var a=new BetaJS.Server.Net.Imap(this.__imap,this.__imap_opts);return a.connect().callback(a.destroy,a)},_query_capabilities:function(){return{skip:!0,limit:!0}},_query:function(a,b){var c=new BetaJS.Server.Net.Imap(this.__imap,this.__imap_opts);return c.connect().mapSuccess(function(){var a={};return"skip"in b&&(a.seq_start=b.skip+1),"limit"in b&&(a.seq_count=b.limit),a.reverse=!0,c.fetch(a).success(function(){c.destroy()},this)},this)},_insert:function(a){BetaJS.Server.Net.Smtp.send(this.__smtp,{from:a.from,to:a.to,subject:a.subject,text_body:a.text_body}).mapCallback(function(b,c){return b?new BetaJS.Stores.StoreException(b):(a.id=c.header["message-id"],a)})}}),BetaJS.Stores.ListenerStore.extend("BetaJS.Stores.ImapListenerStore",{constructor:function(a){this._inherited(BetaJS.Stores.ImapListenerStore,"constructor",a);var b=BetaJS.Objs.extend(BetaJS.Objs.clone(a.base,1),a.imap),c=new BetaJS.Server.Net.Imap(b,{reonnect_on_error:!0});this._auto_destroy(c),c.on("new_mail",function(a){c.fetch({seq_count:a,reverse:!0}).success(function(a){BetaJS.Objs.iter(a,function(a){this._inserted(a)},this)},this)},this),c.connect()}});