/*!
betajs-server - v1.0.0 - 2014-10-02
Copyright (c) Oliver Friedmann
MIT Software License.
*/
BetaJS.Net.AbstractAjax.extend("BetaJS.Server.Net.HttpAjax",{_syncCall:function(){throw"Unsupported"},_asyncCall:function(e,t){var s=BetaJS.Net.Uri.parse(e.uri),i={method:e.method,host:s.host,port:s.port,path:s.path},n=null;e.data&&("GET"==i.method?i.path=i.path+"?"+this.cls.querystring().stringify(e.data):(n=this.cls.querystring().stringify(e.data),n.length>0&&(i.headers={"Content-Type":"application/x-www-form-urlencoded","Content-Length":n.length})));var o=this.cls.http().request(i,function(e){var s="";e.on("data",function(e){s+=e}).on("end",function(){e.statusCode>=200&&300>e.statusCode?BetaJS.SyncAsync.callback(t,"success",s):BetaJS.SyncAsync.callback(t,"exception",s)})});n&&n.length>0&&o.write(n),o.end()}},{__http:null,http:function(){return this.__http||(this.__http=require("http")),this.__http},__querystring:null,querystring:function(){return this.__querystring||(this.__querystring=require("querystring")),this.__querystring}}),BetaJS.Class.extend("BetaJS.Server.Net.Controller",{},{dispatch:function(e,t,s,i){var n=this;n[e](t,s,{success:function(){BetaJS.Types.is_defined(i)&&i()},exception:function(e){e=BetaJS.Server.Net.ControllerException.ensure(e),s.status(e.code()).send(JSON.stringify(e.data()))}})}}),BetaJS.Exceptions.Exception.extend("BetaJS.Server.Net.ControllerException",{constructor:function(e,t){t=t||{},this.__data=t,this.__code=e,this._inherited(BetaJS.Server.Net.ControllerException,"constructor",BetaJS.Net.HttpHeader.format(e,!0))},code:function(){return this.__code},data:function(){return this.__data}}),BetaJS.Class.extend("BetaJS.Server.Net.Imap",[BetaJS.Events.EventsMixin,{constructor:function(e,t){this._inherited(BetaJS.Server.Net.Imap,"constructor"),this.__quoted_printable=require("quoted-printable"),this.__html_strip=require("htmlstrip-native"),this.__auth=e,t=t||{},this.__options=t,this.__count=0,this.__Imap=require("imap"),this.__connected=!1,this.__imap=new this.__Imap(BetaJS.Objs.extend({tls:!0,tlsOptions:{rejectUnauthorized:!1}},e));var s=this;this.__imap.on("mail",function(e){s.__count+=e}),this.__imap.on("error",function(){s.trigger("error"),t.reconnect_on_error&&BetaJS.SyncAsync.eventually(s.reconnect,[],s)})},destroy:function(){this.disconnect(),this._inherited(BetaJS.Server.Net.Imap,"destroy")},connect:function(e){if(!this.__connected){this.__count=0;var t=this,s=function(){BetaJS.SyncAsync.callback(e,"exception"),t.off("error",s)};this.on("error",s),this.__imap.connect(),this.__imap.once("ready",function(){t.__connected=!0;var i=t.__options.mailbox||"INBOX";BetaJS.Types.is_array(i)||(i=[i]),i=BetaJS.Objs.clone(i,1);var n=null,o=function(){if(0===i.length)throw BetaJS.SyncAsync.callback(e,"exception",n),t.__connected=!1,n;var r=i.shift();t.__imap.openBox(r,!0,function(i){return i?(n=i,o(),void 0):(t.on("error",s),t.__imap.on("mail",function(e){t.trigger("new_mail",e)}),BetaJS.SyncAsync.callback(e,"success"),void 0)})};t.off("error",s),o()})}},disconnect:function(){this.__connected&&(this.__imap.end(),this.__connected=!1)},reconnect:function(){this.disconnect(),this.connect()},count:function(){return this.__count},fetch:function(e,t){e=e||{};var s=[];"headers"in e&&!e.headers||s.push("HEADER.FIELDS (FROM TO SUBJECT DATE)"),"body"in e&&!e.body||s.push("TEXT");var i=1,n=100;if(e.seq_count?e.seq_end?(n=e.seq_end,i=n-e.seq_count+1):(i=e.seq_start||i,n=i+e.seq_count-1):(i=e.seq_start||i,n=e.seq_end||i+99),e.reverse){var o=n-i;n=this.__count-i+1,i=n-o}var r=this.__imap.seq.fetch(i+":"+n,{bodies:s,struct:!0});this.__query(r,t)},__query:function(e,t){var s=this,i=[];e.on("message",function(e,t){var n={},o="",r="";e.on("body",function(e,t){e.on("data",function(e){"TEXT"===t.which?r+=e.toString("utf8"):o+=e.toString("utf8")})}),e.once("attributes",function(e){n=e}),e.once("end",function(){n.seqno=t;try{var e=s.__parse(s.__Imap.parseHeader(o),r,n);e&&i.push(e)}catch(a){}})}),e.once("error",function(e){BetaJS.SyncAsync.callback(t,"exception",e)}),e.once("end",function(){BetaJS.SyncAsync.callback(t,"success",i)})},__parse:function(e,t,s){this.trigger("parse",e,t,s);var i={};if(i.uid=s.uid,i.threadid=s["x-gm-thrid"],i.id=s.uid,i.seqid=s.seqno,e&&e.subject&&e.subject.length>0&&(i.subject=e.subject[0]),e&&e.to&&e.to.length>0&&(i.to=e.to[0]),e&&e.from&&e.from.length>0&&(i.from=e.from[0]),e&&e.date&&e.date.length>0){var n=new Date(e.date[0]);i.date=n.getTime()}if(t){var o=s.struct,r=[];if(o.length>1)for(var a=o[0].params.boundary,_=t,c=_.indexOf(a),u=1;o.length>u;++u){var h=o[u][0]||{};if(_=_.substring(_.indexOf(a)+a.length),_=_.substring(_.indexOf("\r\n\r\n")+"\r\n\r\n".length),!h.disposition&&"text"==h.type){var d=_.indexOf(a)-c;r.push({meta:h,body:d>=0?_.substring(0,d):_})}}else r.push({meta:o[0],body:t});for(var l=null,S=null,f=0;r.length>f;++f){var v=r[f].body,m=r[f].meta.encoding.toLowerCase();try{v="quoted-printable"==m?""+this.__quoted_printable.decode(v):""+new Buffer(v,m)}catch(p){}"html"==r[f].meta.subtype?l=v:S=v}!S&&l&&(S=this.__html_strip.html_strip(l,{include_script:!1,include_style:!1,compact_whitespace:!0})),i.html_body=l,i.text_body=S}return i}}]),BetaJS.Server.Net.Smtp={send:function(e,t,s){var i=require("emailjs");t.from=BetaJS.Strings.email_get_email(t.from),t.to=BetaJS.Strings.email_get_email(t.to),t.text_body&&(t.text=t.text_body,delete t.text_body),i.server.connect(e).send(i.message.create(t),function(e,t){e?BetaJS.SyncAsync.callback(s,"exception",e):BetaJS.SyncAsync.callback(s,"success",t)})}},BetaJS.Class.extend("BetaJS.Server.Sessions.Manager",[BetaJS.Events.EventsMixin,BetaJS.Classes.HelperClassMixin,{_session_class:"BetaJS.Server.Sessions.Session",constructor:function(e){this._inherited(BetaJS.Server.Sessions.Manager,"constructor"),e=BetaJS.Objs.tree_extend({invalidation:{session_timeout:864e5,session_inactivity_timeout:36e5,timer:6e4}},e),this.__options=e,this._session_class=e.session_class||this._session_class,BetaJS.Types.is_string(this._session_class)&&(this._session_class=BetaJS.Scopes.resolve(this._session_class)),e.invalidation.timer&&(this.__timer=this._auto_destroy(new BetaJS.Timers.Timer({fire:this.invalidate,context:this,delay:e.invalidation.timer}))),this.__sessions=new BetaJS.Lists.ObjectIdList},destroy:function(){this.iterate(function(e){e.destroy()}),this.__sessions.destroy(),this._inherited(BetaJS.Server.Sessions.Manager,"destroy")},iterate:function(e,t){this.__sessions.iterate(e,t||this)},obtain_session:function(e,t,s){this.find_session(e,{context:this,success:function(i){BetaJS.SyncAsync.callback(s,"success",i||this.new_session(e,t))}})},__generate_token:function(){return BetaJS.Tokens.generate_token()},__lookup_session:function(e,t){this._helper({method:"__lookup_session",callbacks:t},e,t)},find_session:function(e,t){var s=this.__sessions.get(e);s?BetaJS.SyncAsync.callback(t,"success",s):this.__lookup_session(e,t)},__add_session:function(e){this.__sessions.add(e),this._helper("__add_session",e)},new_session:function(e,t){return session=new this._session_class(this,e||this.__generate_token(),t),this.__add_session(session),session},invalidate:function(){this.iterate(function(e){e.invalidate()})},options:function(){return this.__options},__remove_session:function(e){this.__sessions.exists(e)&&(this._helper("remove_session",e),this.__sessions.remove(e))},delete_session:function(e){e.destroy()}}]),BetaJS.Class.extend("BetaJS.Server.Sessions.Session",[BetaJS.Classes.HelperClassMixin,{constructor:function(e,t,s){this._inherited(BetaJS.Server.Sessions.Session,"constructor"),this.__manager=e,this.__options=s,BetaJS.Ids.objectId(this,t),this.initiation_time=BetaJS.Time.now(),this.active_time=this.initiation_time},destroy:function(){this.__manager.__remove_session(this),this._inherited(BetaJS.Server.Sessions.Session,"destroy")},is_active:function(){return this._helper({method:"is_active",fold_start:!1,fold:function(e,t){return e||t}})},activity:function(){this.active_time=BetaJS.Time.now()},invalidate:function(){this._helper("invalidate");var e=this.__manager.options().invalidation,t=BetaJS.Time.now();(e.session_timeout&&t>this.initiation_time+e.session_timeout||!this.is_active()&&e.session_inactivity_timeout&&t>this.active_time+e.session_inactivity_timeout)&&this.destroy()},manager:function(){return this.__manager},options:function(){return this.__options}}]),BetaJS.Class.extend("BetaJS.Server.Session.ActiveSessionManagerHelper",{_active_session_class:"BetaJS.Server.Sessions.ActiveSession",constructor:function(e,t){this._inherited(BetaJS.Server.Session.ActiveSessionManagerHelper,"constructor"),t=BetaJS.Objs.tree_extend({invalidation:{active_session_timeout:36e5,active_session_inactivity_timeout:6e4}},t),this.__options=t,this._active_session_class=t.active_session_class||this._active_session_class,BetaJS.Types.is_string(this._active_session_class)&&(this._active_session_class=BetaJS.Scopes.resolve(this._active_session_class)),e.__add_active_session=function(e,t){this._helper("__add_active_session",e,t)}},__add_session:function(e){e.addHelper(BetaJS.Server.Session.ActiveSessionHelper,this)},options:function(){return this.__options}}),BetaJS.Class.extend("BetaJS.Server.Session.ActiveSessionHelper",[BetaJS.Classes.HelperClassMixin,{constructor:function(e,t){this._inherited(BetaJS.Server.Session.ActiveSessionHelper,"constructor"),this.__helper=t,this.__session=e,e.active_sessions=this,this.__active_sessions=new BetaJS.Lists.ObjectIdList},destroy:function(){this.iterate(function(e){e.destroy()},this),this.__active_sessions.destroy(),this._inherited(BetaJS.Server.Session.ActiveSessionHelper,"destroy")},session:function(){return this.__session},helper:function(){return this.__helper},invalidate:function(){this.iterate(function(e){e.invalidate()},this)},iterate:function(e,t){this.__active_sessions.iterate(e,t||this)},is_active:function(){return this.__active_sessions.count()>0},find_active_session:function(e){return this.__active_sessions.get(e)},__generate_token:function(){return BetaJS.Tokens.generate_token()},__remove_active_session:function(e){this.__active_sessions.exists(e)&&(this.__active_sessions.remove(e),this.__session.activity())},delete_active_session:function(e){e.destroy()},obtain_active_session:function(e,t){return this.find_active_session(e)||this.new_active_session(e,t)},__add_active_session:function(e){this.__active_sessions.add(e),this.session().manager().__add_active_session(this.session(),e)},new_active_session:function(e,t){return active_session=new this.__helper._active_session_class(this,e||this.__generate_token(),t),this.__add_active_session(active_session),active_session},continue_active_session:function(e){var t=null;return this.iterate(function(s){return s.suspended()&&s.can_continue(e)?(t=s,!1):!0}),t},attach_active_session:function(e){return this.continue_active_session(e)||this.new_active_session(null,e)}}]),BetaJS.Class.extend("BetaJS.Server.Sessions.ActiveSession",[BetaJS.Classes.HelperClassMixin,BetaJS.Events.EventsMixin,{constructor:function(e,t,s){this._inherited(BetaJS.Server.Sessions.ActiveSession,"constructor"),this.__helper=e,this.__options=s||{},BetaJS.Ids.objectId(this,t),this.initiation_time=BetaJS.Time.now(),this.active_time=this.initiation_time},destroy:function(){this.trigger("destroy"),this.__helper.__remove_active_session(this),this._inherited(BetaJS.Server.Sessions.ActiveSession,"destroy")},options:function(){return this.__options},activity:function(){this.active_time=BetaJS.Time.now()},suspended:function(){return this._helper({method:"suspended",fold_start:!1,fold:function(e,t){return e||t}})},can_continue:function(){return!1},invalidate:function(){var e=this.__helper.helper().options().invalidation,t=BetaJS.Time.now();(e.active_session_timeout&&t>this.initiation_time+e.active_session_timeout||this.suspended()&&e.active_session_inactivity_timeout&&t>this.active_time+e.active_session_inactivity_timeout)&&this.destroy()}}]),BetaJS.Class.extend("BetaJS.Server.Session.PersistentSessionManagerHelper",{_persistent_session_model:"BetaJS.Server.Sessions.PersistentSessionModel",constructor:function(e,t){this._inherited(BetaJS.Server.Session.PersistentSessionManagerHelper,"constructor"),this.__manager=e,t=BetaJS.Objs.tree_extend({invalidation:{session_timeout:31536e6,timer:864e5}},t),this.__options=t,this.__store=t.store?t.store:this._auto_destroy(new BetaJS.Stores.MemoryStore),this._persistent_session_model=t.persistent_session_model||this._persistent_session_model,BetaJS.Types.is_string(this._persistent_session_model)&&(this._persistent_session_model=BetaJS.Scopes.resolve(this._persistent_session_model)),t.invalidation.timer&&(this.__timer=this._auto_destroy(new BetaJS.Timers.Timer({fire:this.invalidate,context:this,delay:t.invalidation.timer}))),this.__table=this._auto_destroy(new BetaJS.Modelling.Table(this.__store,this._persistent_session_model))},__lookup_session:function(e,t){this.__table.findBy({token:e},{context:this,success:function(s){if(s){var i=this.__manager.new_session(e,{model:s});BetaJS.SyncAsync.callback(t,"success",i)}else BetaJS.SyncAsync.callback(t,"success",null)},failure:function(){BetaJS.SyncAsync.callback(t,"success",null)}})},__add_session:function(e){var t=e.options();t.model||(t.model=new this._persistent_session_model({token:e.cid(),created:BetaJS.Time.now()}),t.model.save()),e.model=t.model,e.model.session=e},options:function(){return this.__options},invalidate:function(){if(this.__options.invalidation.session_timeout){var e=BetaJS.Time.now()-this.__options.invalidation.session_timeout;this.__table.allBy({created:{$lt:e}},{},{context:this,success:function(e){for(;e.hasNext();){var t=e.next();t.session&&this.__manager.delete_session(t.session),t.remove()}}})}}}),BetaJS.Modelling.Model.extend("BetaJS.Server.Sessions.PersistentSessionModel",{},{_initializeScheme:function(){var e=this._inherited(BetaJS.Server.Sessions.PersistentSessionModel,"_initializeScheme");return e.token={type:"string",index:!0},e.created={type:"date",index:!0},e}}),BetaJS.Class.extend("BetaJS.Server.Session.RMIManagerHelper",{__add_active_session:function(e,t){t.addHelper(BetaJS.Server.Session.RMIHelper)}}),BetaJS.Class.extend("BetaJS.Server.Session.RMIHelper",{constructor:function(e){this._inherited(BetaJS.Server.Session.RMIHelper,"constructor"),this.__active_session=e,e.rmi=this,this.__rmi_sender=new BetaJS.Net.SocketSenderChannel(null,"rmi",!1),this.__rmi_receiver=new BetaJS.Net.SocketReceiverChannel(null,"rmi"),this.__rmi_peer=new BetaJS.RMI.Peer(this.__rmi_sender,this.__rmi_receiver),e.rmi_peer=this.__rmi_peer,this.stubs={},this.skeletons={},e.stubs=this.stubs,e.skeletons=this.skeletons,e.on("bind_socket",function(e){this.__rmi_receiver.socket(e),this.__rmi_sender.socket(e),this.__rmi_sender.ready()},this),e.on("unbind_socket",function(){this.__rmi_sender.unready()},this),"initialize_rmi"in e&&e.initialize_rmi()},destroy:function(){for(var e in this.stubs)this.stubs[e].destroy;for(e in this.skeletons)this.skeletons[e].destroy;this.__rmi_peer.destroy(),this.__rmi_receiver.destroy(),this.__rmi_sender.destroy(),this._inherited(BetaJS.Server.Session.RMIHelper,"destroy")}}),BetaJS.Class.extend("BetaJS.Server.Session.SocketsManagerHelper",{constructor:function(e){this._inherited(BetaJS.Server.Session.SocketsManagerHelper,"constructor"),this.__manager=e,e.bind_socket=function(e,t,s){var i=BetaJS.Strings.read_cookie_string(e.handshake.headers.cookie,t,s);this.find_session(i,{context:this,success:function(t){if(!t)return e.disconnect(),void 0;var i=t.active_sessions.find_active_session(s.active_session_token);return i?(i.socket.bind(e),void 0):(e.disconnect(),void 0)}})}},__add_active_session:function(e,t){t.addHelper(BetaJS.Server.Session.SocketsHelper)}}),BetaJS.Class.extend("BetaJS.Server.Session.SocketsHelper",{constructor:function(e){this._inherited(BetaJS.Server.Session.SocketsHelper,"constructor"),this.__active_session=e,e.socket=this},destroy:function(){this.unbind_socket(),this._inherited(BetaJS.Server.Session.SocketsHelper,"destroy")},suspended:function(){return!this.socket()},bind:function(e){if(e!=this.__socket){this.unbind(),this.__socket=e;var t=this;e.on("disconnect",function(){t.unbind()}),this.__active_session.trigger("bind_socket",e)}},unbind:function(){this.__socket=null,this.__active_session.activity(),this.__active_session.trigger("unbind_socket")},socket:function(){return this.__socket}}),BetaJS.Class.extend("BetaJS.Databases.Database",[BetaJS.SyncAsync.SyncAsyncMixin,{_tableClass:function(){return null},getTable:function(e){var t=this._tableClass();return new t(this,e)}}]),BetaJS.Class.extend("BetaJS.Databases.DatabaseTable",[BetaJS.SyncAsync.SyncAsyncMixin,{constructor:function(e,t){this._inherited(BetaJS.Databases.DatabaseTable,"constructor"),this._database=e,this._table_name=t},supportsSync:function(){return this._database.supportsSync()},supportsAsync:function(){return this._database.supportsAsync()},findOne:function(e,t,s){return this.then(this._findOne,[this._encode(e),t],s,function(e,t){BetaJS.SyncAsync.callback(t,"success",e?this._decode(e):null)})},_findOne:function(e,t,s){return t=t||{},t.limit=1,this.then(this._find,[e,t],s,function(e,t){BetaJS.SyncAsync.callback(t,"success",e.next())})},_encode:function(e){return e},_decode:function(e){return e},_find:function(){},find:function(e,t,s){return this.then(this._find,[this._encode(e),t],s,function(e,t){BetaJS.SyncAsync.callback(t,"success",new BetaJS.Iterators.MappedIterator(e,this._decode,this))})},findById:function(e,t){return this.findOne({id:e},{},t)},_insertRow:function(){},_removeRow:function(){},_updateRow:function(){},insertRow:function(e,t){return this.then(this._insertRow,[this._encode(e)],t,function(e,t){BetaJS.SyncAsync.callback(t,"success",this._decode(e))})},removeRow:function(e,t){return this._removeRow(this._encode(e),t)},updateRow:function(e,t,s){return this.then(this._updateRow,[this._encode(e),this._encode(t)],s,function(e,t){BetaJS.SyncAsync.callback(t,"success",this._decode(e))})},removeById:function(e,t){return this.removeRow({id:e},t)},updateById:function(e,t,s){return this.updateRow({id:e},t,s)},ensureIndex:function(){}}]),BetaJS.Databases.Database.extend("BetaJS.Databases.MongoDatabase",{constructor:function(e,t){BetaJS.Types.is_string(e)?(this.__dbUri=BetaJS.Strings.strip_start(e,"mongodb://"),this.__dbObject=this.cls.uriToObject(e)):(e=BetaJS.Objs.extend({database:"database",server:"localhost",port:27017},e),this.__dbObject=e,this.__dbUri=this.cls.objectToUri(e)),this._inherited(BetaJS.Databases.MongoDatabase,"constructor"),t=t||{},this._supportsAsync="async"in t?t.async:!1,this._supportsSync="sync"in t?t.sync:!this.__supportsAsync},_tableClass:function(){return BetaJS.Databases.MongoDatabaseTable},mongo_module_sync:function(){return this.__mongo_module_sync||(this.__mongo_module_sync=require("mongo-sync")),this.__mongo_module_sync},mongo_module_async:function(){return this.__mongo_module_async||(this.__mongo_module_async=require("mongodb")),this.__mongo_module_async},mongo_object_id:function(){return this.supportsSync()?this.mongo_module_sync().ObjectId:this.mongo_module_async().BSONNative.ObjectID},mongodb_sync:function(e){return this.eitherSyncFactory("__mongodb_sync",e,function(){var e=this.mongo_module_sync();this.__mongo_server_sync=new e.Server(this.__dbObject.server+":"+this.__dbObject.port);var t=this.__mongo_server_sync.db(this.__dbObject.database);return this.__dbObject.username&&t.auth(this.__dbObject.username,this.__dbObject.password),t})},mongodb_async:function(e){return this.eitherAsyncFactory("__mongodb_async",e,function(e){var t=this.mongo_module_async().MongoClient;t.connect("mongodb://"+this.__dbUri,{server:{auto_reconnect:!0}},BetaJS.SyncAsync.toCallbackType(e,BetaJS.SyncAsync.ASYNCSINGLE))})},destroy:function(){this.__mongo_server_sync&&this.__mongo_server_sync.close(),this.__mongo_server_async&&this.__mongo_server_async.close(),this._inherited(BetaJS.Databases.MongoDatabase,"destroy")}},{uriToObject:function(e){var t=BetaJS.Net.Uri.parse(e);return{database:BetaJS.Strings.strip_start(t.path,"/"),server:t.host,port:t.port,username:t.user,password:t.password}},objectToUri:function(e){return e.path=e.database,BetaJS.Net.Uri.build(e)}}),BetaJS.Databases.DatabaseTable.extend("BetaJS.Databases.MongoDatabaseTable",{constructor:function(e,t){this._inherited(BetaJS.Databases.MongoDatabaseTable,"constructor",e,t)},table_sync:function(e){return this.eitherSyncFactory("__table_sync",e,function(){return this._database.mongodb_sync().getCollection(this._table_name)})},table_async:function(e){var t=this;return this.eitherAsyncFactory("__table_async",e,function(){this._database.mongodb_async(BetaJS.SyncAsync.mapSuccess(e,function(s){BetaJS.SyncAsync.callback(e,"success",s.collection(t._table_name))}))})},table:function(e){return this.either(e,this.table_sync,this.table_async)},_encode:function(e){var t=BetaJS.Objs.clone(e,1);if("id"in e){delete t.id;var s=this._database.mongo_object_id();t._id=new s(e.id)}return t},_decode:function(e){var t=BetaJS.Objs.clone(e,1);return"_id"in e&&(delete t._id,t.id=e._id),t},_find:function(e,t,s){return this.then(this.table,s,function(s,i){this.thenSingle(s,s.find,[e],i,function(e,s){t=t||{},"sort"in t&&(e=e.sort(t.sort)),"skip"in t&&(e=e.skip(t.skip)),"limit"in t&&(e=e.limit(t.limit)),this.thenSingle(e,e.toArray,s,function(e,t){BetaJS.SyncAsync.callback(t,"success",new BetaJS.Iterators.ArrayIterator(e))})})})},_insertRow:function(e,t){return this.then(this.table,t,function(t,s){this.thenSingle(t,t.insert,[e],s,function(e,t){BetaJS.SyncAsync.callback(t,"success",e[0]?e[0]:e)})})},_removeRow:function(e,t){return this.then(this.table,t,function(t,s){this.thenSingle(t,t.remove,[e],s)})},_updateRow:function(e,t,s){return this.then(this.table,s,function(s,i){this.thenSingle(s,s.update,[e,{$set:t}],i,function(e,s){BetaJS.SyncAsync.callback(s,"success",t)})})},ensureIndex:function(e){var t={};t[e]=1,this.table({success:function(e){e.ensureIndex(t,function(){})}})}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.DatabaseStore",{constructor:function(e,t,s){this._inherited(BetaJS.Stores.DatabaseStore,"constructor"),this.__database=e,this.__table_name=t,this.__table=null,this.__foreign_id=s},table:function(){return this.__table||(this.__table=this.__database.getTable(this.__table_name)),this.__table},_insert:function(e,t){if(!this.__foreign_id||!e[this.__foreign_id])return this.table().insertRow(e,t);var s={};return s[this.__foreign_id]=e[this.__foreign_id],this.table().findOne(s,{},{context:this,success:function(s){return s?BetaJS.SyncAsync.callback(t,"success",s):this.table().insertRow(e,t)},exception:function(e){BetaJS.SyncAsync.callback(t,"exception",e)}})},_remove:function(e,t){if(!this.__foreign_id)return this.table().removeById(e,t);var s={};return s[this.__foreign_id]=e,this.table().removeRow(s,t)},_get:function(e,t){if(!this.__foreign_id)return this.table().findById(e,t);var s={};return s[this.__foreign_id]=e,this.table().findOne(s,{},t)},_update:function(e,t,s){if(!this.__foreign_id)return this.table().updateById(e,t,s);var i={};return i[this.__foreign_id]=e,this.updateRow(i,t,s)},_query_capabilities:function(){return{query:!0,sort:!0,skip:!0,limit:!0}},_query:function(e,t,s){return this.table().find(e,t,s)},_ensure_index:function(e){this.table().ensureIndex(e)}}),BetaJS.Stores.ConversionStore.extend("BetaJS.Stores.MongoDatabaseStore",{constructor:function(e,t,s,i){var n=new BetaJS.Stores.DatabaseStore(e,t,i),o={},r={};s=s||{};var a=e.mongo_object_id();i||(s.id="id");for(var _ in s)"id"==s[_]&&(o[_]=function(e){return e?new a(e):null},r[_]=function(e){return e?e+"":null});var c={value_encoding:o,value_decoding:r};i&&(c.key_encoding={id:i},c.key_encoding[i]=null,c.key_decoding={id:null},c.key_encoding[i]="id"),this._inherited(BetaJS.Stores.MongoDatabaseStore,"constructor",n,c)}}),BetaJS.Class.extend("BetaJS.Stores.Migrator",{constructor:function(){this._inherited(BetaJS.Stores.Migrator,"constructor"),this.__version=null,this.__migrations=[],this.__sorted=!0},version:function(){return this.__version||(this.__version=this._getVersion()),this.__version},_getVersion:function(){},_setVersion:function(){},_log:function(){},migrations:function(){return this.__sorted||(this.__migrations.sort(function(e,t){return e.version-t.version}),this.__sorted=!0),this.__migrations},register:function(e){this.__migrations.push(e),this.__sorted=!1},_indexByVersion:function(e){for(var t=0;this.__migrations.length>t;++t){if(e==this.__migrations[t].version)return t;if(this.__migrations[t].version>e)return t-1}return this.__migrations.length},migrate:function(e){for(var t=this._indexByVersion(this.version()),s=BetaJS.Types.is_defined(e)?this._indexByVersion(e):this.__migrations.length-1;s>t;){var i=this.__migrations[t+1];this._log("Migrate "+i.version+": "+i.title+" - "+i.description+"...\n");try{i.migrate(),this._setVersion(this.__migrations[t+1].version),t++,this._log("Successfully migrated "+i.version+".\n")}catch(n){this._log("Failure! Rolling back "+i.version+"...\n");try{i.partial_rollback()}catch(n){throw this._log("Failure! Couldn't roll back "+i.version+"!\n"),n}throw this._log("Rolled back "+i.version+"!\n"),n}}},rollback:function(e){for(var t=this._indexByVersion(this.version()),s=BetaJS.Types.is_defined(e)?this._indexByVersion(s):-1;t>s;){var i=this.__migrations[t];this._log("Rollback "+i.version+": "+i.title+" - "+i.description+"...\n");try{i.rollback(),this._setVersion(t>=1?this.__migrations[t-1].version:0),t--,this._log("Successfully rolled back "+i.version+".\n")}catch(n){throw this._log("Failure! Couldn't roll back "+i.version+"!\n"),n}}}}),BetaJS.Stores.BaseStore.extend("BetaJS.Stores.ImapStore",{constructor:function(e){this._inherited(BetaJS.Stores.ImapStore,"constructor",e),this._supportSync=!1,this.__imap=BetaJS.Objs.extend(BetaJS.Objs.clone(e.base,1),e.imap),this.__smtp=BetaJS.Objs.extend(BetaJS.Objs.clone(e.base,1),e.smtp),this.__imap_opts=e.imap_options||{},this.__imap_opts.reconnect_on_error=!1},test:function(e){var t=new BetaJS.Server.Net.Imap(this.__imap,this.__imap_opts);t.connect({success:function(){t.destroy(),BetaJS.SyncAsync.callback(e,"success")},exception:function(){t.destroy(),BetaJS.SyncAsync.callback(e,"exception")}})},_query_capabilities:function(){return{skip:!0,limit:!0}},_query:function(e,t,s){var i=this,n=new BetaJS.Server.Net.Imap(this.__imap,this.__imap_opts);n.connect(BetaJS.SyncAsync.mapSuccess(s,function(){var e={};"skip"in t&&(e.seq_start=t.skip+1),"limit"in t&&(e.seq_count=t.limit),e.reverse=!0,n.fetch(e,BetaJS.SyncAsync.mapSuccess(s,function(e){i.callback(s,"success",BetaJS.Objs.map(e,function(e){return e})),n.destroy()}))}))},_insert:function(e,t){BetaJS.Server.Net.Smtp.send(this.__smtp,{from:e.from,to:e.to,subject:e.subject,text_body:e.text_body},{context:t.context,success:function(s){e.id=s.header["message-id"],BetaJS.SyncAsync.callback(t,"success",e)},exception:function(e){BetaJS.SyncAsync.callback(t,"exception",new BetaJS.Stores.StoreException(e))}})}}),BetaJS.Stores.ListenerStore.extend("BetaJS.Stores.ImapListenerStore",{constructor:function(e){this._inherited(BetaJS.Stores.ImapListenerStore,"constructor",e);var t=BetaJS.Objs.extend(BetaJS.Objs.clone(e.base,1),e.imap),s=new BetaJS.Server.Net.Imap(t,{reonnect_on_error:!0});this._auto_destroy(s),s.on("new_mail",function(e){s.fetch({seq_count:e,reverse:!0},{context:this,success:function(e){BetaJS.Objs.iter(e,function(e){this._inserted(e)},this)}})},this),s.connect()}});