/*!
betajs-server - v1.0.20 - 2017-06-08
Copyright (c) Oliver Friedmann
Apache-2.0 Software License.
*/
var Scoped=function(){function a(a){function b(a){return{route:"string"==typeof a.route?a.route:null,parent:"object"==typeof a.parent?a.parent:null,ready:"boolean"==typeof a.ready?a.ready:!1,children:{},watchers:[],data:{},lazy:[]}}function c(a){if(!a.ready){if(a.parent&&!a.parent.ready)return void c(a.parent);if(a.route&&a.parent&&a.route in a.parent.data){a.data=a.parent.data[a.route],a.ready=!0;for(var b=0;b<a.watchers.length;++b)a.watchers[b].callback.call(a.watchers[b].context||this,a.data);a.watchers=[];for(var d in a.children)c(a.children[d])}}}function d(a){if(!a.ready){a.parent&&!a.parent.ready&&d(a.parent),a.ready=!0,a.parent&&j.tree&&"object"==typeof a.parent.data&&(a.parent.data[a.route]=a.data);for(var b=0;b<a.watchers.length;++b)a.watchers[b].callback.call(a.watchers[b].context||this,a.data);a.watchers=[]}}function e(a,b){if("object"==typeof b&&a.ready)for(var e in b)a.data[e]=b[e];else a.data=b;if("object"==typeof b)for(var f in b)a.children[f]&&(a.children[f].data=b[f]);d(a);for(var g in a.children)c(a.children[g])}function f(a){if(a.ready&&a.data)for(var b in a.data)delete a.data[b]}function g(a){if(!a)return k;for(var d=a.split("."),e=k,f=0;f<d.length;++f)d[f]in e.children?e=e.children[d[f]]:(e.children[d[f]]=b({parent:e,route:d[f]}),e=e.children[d[f]],c(e));return e}function h(a,b,c){if(a.ready)b.call(c||this,a.data);else if(a.watchers.push({callback:b,context:c}),a.lazy.length>0){var d=function(a){if(a.lazy.length>0){var b=a.lazy.shift();b.callback.call(b.context||this,a.data),d(a)}};d(a)}}function i(a,b,c){a=a||k,c=c||[],a.ready||c.push(b);for(var d in a.children){var e=a.children[d],f=(b?b+".":"")+e.route;c=i(e,f,c)}return c}var j={tree:"boolean"==typeof a.tree?a.tree:!1,global:"boolean"==typeof a.global?a.global:!1,root:"object"==typeof a.root?a.root:{}},k=b({ready:!0});if(j.tree)if(j.global){try{window&&(k.data=window)}catch(l){}try{global&&(k.data=global)}catch(l){}try{self&&(k.data=self)}catch(l){}}else k.data=j.root;return{extend:function(a,b){e(g(a),b)},set:function(a,b){var c=g(a);c.data&&f(c),e(c,b)},get:function(a){var b=g(a);return b.ready?b.data:null},lazy:function(a,b,c){var d=g(a);d.ready?b(c||this,d.data):d.lazy.push({callback:b,context:c})},digest:function(a){c(g(a))},obtain:function(a,b,c){h(g(a),b,c)},unresolvedWatchers:function(a){return i(g(a),a)},__export:function(){return{options:j,nsRoot:k}},__import:function(a){j=a.options,k=a.nsRoot}}}function b(e,f,g,h){var i=null,j=[],k=f,l=g,m=h,n=a({tree:!0}),o=a({tree:!1}),p={global:{namespace:m},root:{namespace:l},local:{namespace:n},"default":{namespace:o},parent:{namespace:k},scope:{namespace:n,readonly:!1}},q=function(a,b,c){var e=d.matchArgs(a,{options:"object",namespaceLocator:!0,dependencies:"array",hiddenDependencies:"array",callback:!0,context:"object"}),f=d.extend({lazy:this.options.lazy},e.options||{}),g=this.resolve(e.namespaceLocator),h=function(){this.require(e.dependencies,e.hiddenDependencies,function(){if(arguments[arguments.length-1].ns=g,this.options.compile){for(var f=[],h=0;h<a.length;++h)f.push(d.stringify(a[h]));this.compiled+=this.options.ident+"."+b+"("+f.join(", ")+");\n\n"}this.options.dependencies&&(this.dependencies[g.path]=this.dependencies[g.path]||{},e.dependencies&&e.dependencies.forEach(function(a){this.dependencies[g.path][this.resolve(a).path]=!0},this),e.hiddenDependencies&&e.hiddenDependencies.forEach(function(a){this.dependencies[g.path][this.resolve(a).path]=!0},this));var i=this.options.compile?{}:e.callback.apply(e.context||this,arguments);c.call(this,g,i)},this)};return f.lazy?g.namespace.lazy(g.path,h,this):h.apply(this),this};return{getGlobal:d.method(c,c.getPath),setGlobal:d.method(c,c.setPath),options:{lazy:!1,ident:"Scoped",compile:!1,dependencies:!1},compiled:"",dependencies:{},nextScope:function(){return i||(i=b(this,n,l,m)),i},subScope:function(){var a=this.nextScope();return j.push(a),i=null,a},binding:function(b,c,e){if(!p[b]||!p[b].readonly){var f;f="string"!=d.typeOf(c)?{namespace:a({tree:!0,root:c}),path:null}:this.resolve(c),p[b]=d.extend(e,f)}return this},resolve:function(a){var b=a.split(":");if(1==b.length)return{namespace:o,path:b[0]};var c=p[b[0]];if(!c)throw"The namespace '"+b[0]+"' has not been defined (yet).";return{namespace:c.namespace,path:c.path&&b[1]?c.path+"."+b[1]:c.path||b[1]}},define:function(){return q.call(this,arguments,"define",function(a,b){if(a.namespace.get(a.path))throw"Scoped namespace "+a.path+" has already been defined. Use extend to extend an existing namespace instead";a.namespace.set(a.path,b)})},assumeVersion:function(){var a=d.matchArgs(arguments,{assumption:!0,dependencies:"array",callback:!0,context:"object",error:"string"}),b=a.dependencies||[];b.unshift(a.assumption),this.require(b,function(){var b=arguments,c=b[0].replace(/[^\d\.]/g,"");b[0]=c.split(".");for(var e=0;e<b[0].length;++e)b[0][e]=parseInt(b[0][e],10);if("function"===d.typeOf(a.callback)){if(!a.callback.apply(a.context||this,a))throw"Scoped Assumption '"+a.assumption+"' failed, value is "+c+(a.error?", but assuming "+a.error:"")}else for(var f=(a.callback+"").replace(/[^\d\.]/g,"").split("."),g=0;g<Math.min(b[0].length,f.length);++g)if(parseInt(f[g],10)>b[0][g])throw"Scoped Version Assumption '"+a.assumption+"' failed, value is "+c+", but assuming at least "+a.callback})},extend:function(){return q.call(this,arguments,"extend",function(a,b){a.namespace.extend(a.path,b)})},require:function(){var a=d.matchArgs(arguments,{dependencies:"array",hiddenDependencies:"array",callback:"function",context:"object"});a.callback=a.callback||function(){};var b=a.dependencies||[],c=b.concat(a.hiddenDependencies||[]),e=c.length,f=[],g={};if(e)for(var h=function(b){this.i<f.length&&(f[this.i]=b),e--,0===e&&(f.push(g),a.callback.apply(a.context||this.ctx,f))},i=0;i<c.length;++i){var j=this.resolve(c[i]);i<b.length&&f.push(null),j.namespace.obtain(j.path,h,{ctx:this,i:i})}else f.push(g),a.callback.apply(a.context||this,f);return this},digest:function(a){var b=this.resolve(a);return b.namespace.digest(b.path),this},unresolved:function(a){var b=this.resolve(a);return b.namespace.unresolvedWatchers(b.path)},__export:function(){return{parentNamespace:k.__export(),rootNamespace:l.__export(),globalNamespace:m.__export(),localNamespace:n.__export(),privateNamespace:o.__export()}},__import:function(a){k.__import(a.parentNamespace),l.__import(a.rootNamespace),m.__import(a.globalNamespace),n.__import(a.localNamespace),o.__import(a.privateNamespace)}}}var c=function(){return{get:function(a){return"undefined"!=typeof window?window[a]:"undefined"!=typeof global?global[a]:"undefined"!=typeof self?self[a]:void 0},set:function(a,b){return"undefined"!=typeof window&&(window[a]=b),"undefined"!=typeof global&&(global[a]=b),"undefined"!=typeof self&&(self[a]=b),b},getPath:function(a){var b=a.split(".");if(1==b.length)return this.get(a);for(var c=this.get(b[0]),d=1;d<b.length;++d){if(!c)return c;c=c[b[d]]}return c},setPath:function(a,b){var c=a.split(".");if(1==c.length)return this.set(a,b);for(var d=this.get(c[0])||this.set(c[0],{}),e=1;e<c.length-1;++e)c[e]in d||(d[c[e]]={}),d=d[c[e]];return d[c[c.length-1]]=b,b}}}.call(this),d=function(){return{method:function(a,b){return function(){return b.apply(a,arguments)}},extend:function(a,b){a=a||{},b=b||{};for(var c in b)a[c]=b[c];return a},typeOf:function(a){return"[object Array]"===Object.prototype.toString.call(a)?"array":typeof a},isEmpty:function(a){if(null===a||"undefined"==typeof a)return!0;if("array"==this.typeOf(a))return 0===a.length;if("object"!=typeof a)return!1;for(var b in a)return!1;return!0},matchArgs:function(a,b){var c=0,d={};for(var e in b)b[e]===!0||this.typeOf(a[c])==b[e]?(d[e]=a[c],c++):"undefined"==this.typeOf(a[c])&&c++;return d},stringify:function(a){return"function"==this.typeOf(a)?""+a:JSON.stringify(a)}}}.call(this),e=function(){return{__namespace:"Scoped",__revert:null,upgrade:function(a){var b=c.get(a||e.__namespace);if(b&&"object"==d.typeOf(b)&&b.guid==this.guid&&"string"==d.typeOf(b.version)){for(var f=this.version.split("."),g=b.version.split("."),h=!1,i=0;i<Math.min(f.length,g.length)&&(h=parseInt(f[i],10)>parseInt(g[i],10),f[i]==g[i]);++i);return h?this.attach(a):b}return this.attach(a)},attach:function(a){a&&(e.__namespace=a);var b=c.get(e.__namespace);if(b==this)return this;if(e.__revert=b,b)try{var d=b.__exportScoped();this.__exportBackup=this.__exportScoped(),this.__importScoped(d)}catch(f){}return c.set(e.__namespace,this),this},detach:function(a){return a&&c.set(e.__namespace,null),"undefined"!=typeof e.__revert&&c.set(e.__namespace,e.__revert),delete e.__revert,e.__exportBackup&&this.__importScoped(e.__exportBackup),this},exports:function(a,b,c){return a=a||("undefined"!=typeof module?module:null),"object"==typeof a&&a&&"exports"in a&&(c||a.exports==this||!a.exports||d.isEmpty(a.exports))&&(a.exports=b||this),this}}}.call(this),f=a({tree:!0,global:!0}),g=a({tree:!0}),h=b(null,g,g,f),i=d.extend(h,function(){return{guid:"4b6878ee-cb6a-46b3-94ac-27d91f58d666",version:"0.0.13",upgrade:e.upgrade,attach:e.attach,detach:e.detach,exports:e.exports,__exportScoped:function(){return{globalNamespace:f.__export(),rootNamespace:g.__export(),rootScope:h.__export()}},__importScoped:function(a){f.__import(a.globalNamespace),g.__import(a.rootNamespace),h.__import(a.rootScope)}}}.call(this));return i=i.upgrade(),i.exports(),i}.call(this);(function(){var a=this.subScope();a.binding("module","global:BetaJS.Server"),a.binding("base","global:BetaJS"),a.binding("data","global:BetaJS.Data"),a.define("module:",function(){return{guid:"9955100d-6a88-451f-9a85-004523eb8589",version:"1.0.20"}}),a.assumeVersion("base:version","~1.0.96"),a.assumeVersion("data:version","~1.0.41"),a.define("module:Ajax.NodeAjax",["base:Ajax.Support","base:Net.Uri","base:Net.HttpHeader","base:Promise","base:Objs","base:Types","base:Ajax.RequestException"],function(a,b,c,d,e,f,g){var h={supports:function(a){return!0},execute:function(g){var h=b.appendUriParams(g.uri,g.query||{});"GET"===g.method&&(h=b.appendUriParams(h,g.data||{}));var i=b.parse(h),j={method:g.method,host:i.host,port:i.port,path:i.path+(i.query?"?"+i.query:"")};j.headers={},i.user||i.password?j.headers.Authorization="Basic "+new Buffer(i.user+":"+i.password).toString("base64"):g.bearer&&(j.headers.Authorization="Bearer "+g.bearer);var k=null,l=null;if("GET"!==g.method&&!f.is_empty(g.data)){var m=require("fs");e.iter(g.data,function(a){!l&&a instanceof m.ReadStream&&(l=new(require("form-data")))}),l?e.iter(g.data,function(a,b){l.append(b,a)}):"json"===g.contentType?(g.sendContentType&&(j.headers["Content-Type"]="application/json;charset=UTF-8"),k=JSON.stringify(g.data)):(g.sendContentType&&(j.headers["Content-type"]="application/x-www-form-urlencoded"),k=b.encodeUriParams(g.data,void 0,!0)),k&&(j.headers["Content-Length"]=k.length)}var n=d.create();g.cookies&&(j.headers.Cookie=b.encodeUriParams(g.cookies)),l&&(j.headers=e.extend(j.headers,l.getHeaders()));var o=require("https"===i.protocol?"https":"http").request(j,function(b){var d="";b.on("data",function(a){d+=a}).on("end",function(){c.isSuccessStatus(b.statusCode)?a.promiseReturnData(n,g,d,g.decodeType||"json"):a.promiseRequestException(n,b.statusCode,b.statusText,d,g.decodeType||"json")})});return l?l.pipe(o):(k&&k.length>0&&o.write(k),o.end()),n}};return a.register(h,10),h}),a.define("module:Net.ControllerException",["base:Exceptions.Exception","base:Net.HttpHeader"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(c,d){d=d||{},this.__data=d,this.__code=c,a.constructor.call(this,b.format(c,!0))},code:function(){return this.__code},data:function(){return this.__data}}})}),a.define("module:Net.Controller",["base:Class","base:Promise","base:Types","module:Net.ControllerException"],function(a,b,c,d,e){return a.extend({scoped:e},{},{_beforeDispatch:function(a,c,d){return b.create(!0)},_dispatch:function(a,b,c){return this[a](b,c)},dispatch:function(a,e,f,g){this._beforeDispatch(a,e,f).success(function(){var h=this._dispatch(a,e,f);h=b.is(h)?h:b.create(!0),h.success(function(){c.is_defined(g)&&g()}).error(function(a){a=d.ensure(a),f.status(a.code()).send(JSON.stringify(a.data()))})},this).error(function(a){a=d.ensure(a),f.status(a.code()).send(JSON.stringify(a.data()))})}})}),a.define("module:Net.SessionControllerMixin",function(){return{_obtainSession:function(a,b,c,d,e){return a.obtain_session(d.cookies[b]).mapSuccess(function(c){return d.session=c,e.cookie(b,c.cid(),{maxAge:a.options().invalidation.session_timeout}),c})}}}),a.define("module:Sessions.ActiveSessionHelper",["base:Class","base:Classes.HelperClassMixin","base:Lists.ObjectIdList","base:Tokens"],function(a,b,c,d,e){return a.extend({scoped:e},[b,function(a){return{constructor:function(b,d){a.constructor.call(this),this.__helper=d,this.__session=b,b.active_sessions=this,this.__active_sessions=new c},destroy:function(){this.iterate(function(a){a.destroy()},this),this.__active_sessions.destroy(),a.destroy.call(this)},session:function(){return this.__session},helper:function(){return this.__helper},invalidate:function(){this.iterate(function(a){a.invalidate()},this)},iterate:function(a,b){this.__active_sessions.iterate(a,b||this)},is_active:function(){return this.__active_sessions.count()>0},find_active_session:function(a){return this.__active_sessions.get(a)},__generate_token:function(){return d.generate_token()},__remove_active_session:function(a){this.__active_sessions.exists(a)&&(this.__active_sessions.remove(a),this.__session.activity())},delete_active_session:function(a){a.destroy()},obtain_active_session:function(a,b){return this.find_active_session(a)||this.new_active_session(a,b)},__add_active_session:function(a){this.__active_sessions.add(a),this.session().manager().__add_active_session(this.session(),a)},new_active_session:function(a,b){var c=new this.__helper._active_session_class(this,a||this.__generate_token(),b);return this.__add_active_session(c),c},continue_active_session:function(a){var b=null;return this.iterate(function(c){return c.suspended()&&c.can_continue(a)?(b=c,!1):!0}),b},attach_active_session:function(a){return this.continue_active_session(a)||this.new_active_session(null,a)}}}])}),a.define("module:Sessions.ActiveSession",["base:Class","base:Classes.HelperClassMixin","base:Events.EventsMixin","base:Ids","base:Time"],function(a,b,c,d,e,f){return a.extend({scoped:f},[b,c,function(a){return{constructor:function(b,c,f){a.constructor.call(this),this.__helper=b,this.__options=f||{},d.objectId(this,c),this.initiation_time=e.now(),this.active_time=this.initiation_time},destroy:function(){this.trigger("destroy"),this.__helper.__remove_active_session(this),a.destroy.call(this)},session:function(){return this.__helper.session()},options:function(){return this.__options},activity:function(){this.active_time=e.now()},suspended:function(){return this._helper({method:"suspended",fold_start:!1,fold:function(a,b){return a||b}})},can_continue:function(a){return!1},invalidate:function(){var a=this.__helper.helper().options().invalidation,b=e.now();(a.active_session_timeout&&b>this.initiation_time+a.active_session_timeout||this.suspended()&&a.active_session_inactivity_timeout&&b>this.active_time+a.active_session_inactivity_timeout)&&this.destroy()}}}])}),a.define("module:Sessions.ActiveSessionManagerHelper",["base:Class","module:Sessions.ActiveSession","module:Sessions.ActiveSessionHelper","base:Objs","base:Types"],function(b,c,d,e,f,g){return b.extend({scoped:g},function(b){return{_active_session_class:c,constructor:function(c,d){b.constructor.call(this),d=e.tree_extend({invalidation:{active_session_timeout:36e5,active_session_inactivity_timeout:6e4}},d),this.__options=d,this._active_session_class=d.active_session_class||this._active_session_class,f.is_string(this._active_session_class)&&(this._active_session_class=a.getGlobal(this._active_session_class)),c.__add_active_session=function(a,b){this._helper("__add_active_session",a,b)}},__add_session:function(a){a.addHelper(d,this)},options:function(){return this.__options}}})}),a.define("module:Sessions.PersistentSessionModel",["data:Modelling.Model"],function(a,b){return a.extend({scoped:b},{},function(a){return{_initializeScheme:function(){var b=a._initializeScheme.call(this);return b.token={type:"string",index:!0},b.created={type:"date",index:!0},b}}})}),a.define("module:Sessions.PersistentSessionManagerHelper",["base:Class","module:Sessions.PersistentSessionModel","base:Objs","base:Types","data:Stores.MemoryStore","data:Modelling.Table","base:Timers.Timer","base:Time"],function(b,c,d,e,f,g,h,i,j){return b.extend({scoped:j},function(b){return{_persistent_session_model:c,constructor:function(c,i){b.constructor.call(this),this.__manager=c,i=d.tree_extend({invalidation:{session_timeout:31536e6,timer:864e5}},i),this.__options=i,this.__store=i.store?i.store:this._auto_destroy(new f),this._persistent_session_model=i.persistent_session_model||this._persistent_session_model,e.is_string(this._persistent_session_model)&&(this._persistent_session_model=a.getGlobal(this._persistent_session_model)),i.invalidation.timer&&(this.__timer=this._auto_destroy(new h({fire:this.invalidate,context:this,delay:i.invalidation.timer}))),this._persistent_session_model.table||(this._persistent_session_model.table=this._auto_destroy(new g(this.__store,this._persistent_session_model))),this.__table=this._persistent_session_model.table,c.table=this.__table,c.store=this.__store},__lookup_session:function(a){return this.__table.findBy({token:a}).mapCallback(function(b,c){return c&&!b?this.__manager.new_session(a,{model:c}):null},this)},__add_session:function(a){var b=a.options();b.model||(b.model=this.__table.newModel({token:a.cid(),created:i.now()}),b.model.save()),a.model=b.model,a.model.session=a},options:function(){return this.__options},invalidate:function(){if(this.__options.invalidation.session_timeout){var a=i.now()-this.__options.invalidation.session_timeout;this.__table.allBy({created:{$lt:a}}).success(function(a){for(;a.hasNext();){var b=a.next();b.session&&this.__manager.delete_session(b.session),b.remove()}},this)}}}})}),a.define("module:Sessions.RMIHelper",["base:Class","base:Channels.ReadySender","base:Net.SocketSenderChannel","base:Net.SocketReceiverChannel","base:RMI.Peer"],function(a,b,c,d,e,f){return a.extend({scoped:f},function(a){return{constructor:function(f){a.constructor.call(this),this.__active_session=f,f.rmi=this,this.__rmi_sender=new b(new c(null,"rmi")),this.__rmi_receiver=new d(null,"rmi"),this.__rmi_peer=new e(this.__rmi_sender,this.__rmi_receiver),f.rmi_peer=this.__rmi_peer,this.stubs={},this.skeletons={},f.stubs=this.stubs,f.skeletons=this.skeletons,f.on("bind_socket",function(a){this.__rmi_receiver.socket(a),this.__rmi_sender.socket(a),this.__rmi_sender.ready()},this),f.on("unbind_socket",function(){this.__rmi_sender.unready()},this),"initialize_rmi"in f&&f.initialize_rmi()},destroy:function(){for(var b in this.stubs)this.stubs[b].destroy();for(b in this.skeletons)this.skeletons[b].destroy();this.__rmi_peer.destroy(),this.__rmi_receiver.destroy(),this.__rmi_sender.destroy(),a.destroy.call(this)}}})}),a.define("module:Sessions.RMIManagerHelper",["base:Class","module:Sessions.RMIHelper"],function(a,b,c){return a.extend({scoped:c},{__add_active_session:function(a,c){c.addHelper(b)}})}),a.define("module:Sessions.Session",["base:Class","base:Classes.HelperClassMixin","base:Ids","base:Time"],function(a,b,c,d,e){return a.extend({scoped:e},[b,function(a){return{constructor:function(b,e,f){a.constructor.call(this),this.__manager=b,this.__options=f||{},c.objectId(this,e),this.initiation_time=d.now(),this.active_time=this.initiation_time},destroy:function(){this.__manager.__remove_session(this),a.destroy.call(this)},is_active:function(){return this._helper({method:"is_active",fold_start:!1,fold:function(a,b){return a||b}})},activity:function(){this.active_time=d.now()},invalidate:function(){this._helper("invalidate");var a=this.__manager.options().invalidation,b=d.now();(a.session_timeout&&b>this.initiation_time+a.session_timeout||!this.is_active()&&a.session_inactivity_timeout&&b>this.active_time+a.session_inactivity_timeout)&&this.destroy()},manager:function(){return this.__manager},options:function(){return this.__options}}}])}),a.define("module:Sessions.Manager",["base:Class","base:Events.EventsMixin","base:Classes.HelperClassMixin","module:Sessions.Session","base:Objs","base:Types","base:Timers.Timer","base:Lists.ObjectIdList","base:Tokens","base:Promise"],function(b,c,d,e,f,g,h,i,j,k,l){return b.extend({scoped:l},[c,d,function(b){return{_session_class:e,constructor:function(c){b.constructor.call(this),c=f.tree_extend({invalidation:{session_timeout:864e5,session_inactivity_timeout:36e5,timer:6e4}},c),this.__options=c,this._session_class=c.session_class||this._session_class,g.is_string(this._session_class)&&(this._session_class=a.getGlobal(this._session_class)),c.invalidation.timer&&(this.__timer=this._auto_destroy(new h({fire:this.invalidate,context:this,delay:c.invalidation.timer}))),this.__sessions=new i},destroy:function(){this.iterate(function(a){a.destroy()}),this.__sessions.destroy(),b.destroy.call(this)},iterate:function(a,b){this.__sessions.iterate(a,b||this)},obtain_session:function(a,b){return this.find_session(a).mapSuccess(function(c){return c||this.new_session(a,b)},this)},__generate_token:function(){return j.generate_token()},__lookup_session:function(a){return this._helper({method:"__lookup_session",async:!0},a)},find_session:function(a){if(!a)return k.value(null);var b=this.__sessions.get(a);return b?k.create(b):this.__lookup_session(a)},__add_session:function(a){this.__sessions.add(a),this._helper("__add_session",a)},new_session:function(a,b){var c=new this._session_class(this,a||this.__generate_token(),b);return this.__add_session(c),c},invalidate:function(){this.iterate(function(a){a.invalidate()})},options:function(){return this.__options},__remove_session:function(a){this.__sessions.exists(a)&&(this._helper("remove_session",a),this.__sessions.remove(a))},delete_session:function(a){a.destroy()}}}])}),a.define("module:Sessions.SocketsHelper",["base:Class"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b){a.constructor.call(this),this.__active_session=b,b.socket=this},destroy:function(){this.unbind(),a.destroy.call(this)},suspended:function(){return!this.socket()},bind:function(a){if(a!=this.__socket){this.unbind(),this.__socket=a;var b=this;a.on("disconnect",function(){b.unbind()}),this.__active_session.trigger("bind_socket",a)}},unbind:function(){this.__socket&&(this.__socket=null,this.__active_session.activity(),this.__active_session.trigger("unbind_socket"),this.__active_session.session().manager().sockets_manager_helper.__options.remove_on_disconnect&&this.__active_session.destroy())},socket:function(){return this.__socket}}})}),a.define("module:Sessions.SocketsManagerHelper",["base:Class","base:Objs","base:Strings","module:Sessions.SocketsHelper"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{constructor:function(d,e){a.constructor.call(this),this.__manager=d,d.sockets_manager_helper=this,this.__options=b.extend({remove_on_disconnect:!1},e),d.bind_socket=function(a,b,d){var e=c.read_cookie_string(a.handshake.headers.cookie,b,d);this.find_session(e).success(function(b){if(!b)return void a.disconnect();var c=b.active_sessions.find_active_session(d.active_session_token);return c?void c.socket.bind(a):void a.disconnect()},this)}},__add_active_session:function(a,b){b.addHelper(d)}}})})}).call(Scoped);