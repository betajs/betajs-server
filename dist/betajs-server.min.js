/*!
betajs-server - v1.0.25 - 2019-06-28
Copyright (c) Oliver Friedmann
Apache-2.0 Software License.
*/

var Scoped=function(){var h=function(){return{get:function(e){return"undefined"!=typeof window?e?window[e]:window:"undefined"!=typeof global?e?global[e]:global:"undefined"!=typeof self?e?self[e]:self:undefined},set:function(e,t){return"undefined"!=typeof window&&(window[e]=t),"undefined"!=typeof global&&(global[e]=t),"undefined"!=typeof self&&(self[e]=t),t},getPath:function(e){if(!e)return this.get();var t=e.split(".");if(1==t.length)return this.get(e);for(var s=this.get(t[0]),n=1;n<t.length;++n){if(!s)return s;s=s[t[n]]}return s},setPath:function(e,t){var s=e.split(".");if(1==s.length)return this.set(e,t);for(var n=this.get(s[0])||this.set(s[0],{}),i=1;i<s.length-1;++i)s[i]in n||(n[s[i]]={}),n=n[s[i]];return n[s[s.length-1]]=t}}}.call(this),p=function(){return{method:function(e,t){return function(){return t.apply(e,arguments)}},extend:function(e,t){for(var s in e=e||{},t=t||{})e[s]=t[s];return e},typeOf:function(e){return"[object Array]"===Object.prototype.toString.call(e)?"array":typeof e},isEmpty:function(e){if(null==e)return!0;if("array"==this.typeOf(e))return 0===e.length;if("object"!=typeof e)return!1;for(var t in e)return!1;return!0},matchArgs:function(e,t){var s=0,n={};for(var i in t)!0===t[i]||this.typeOf(e[s])==t[i]?(n[i]=e[s],s++):"undefined"==this.typeOf(e[s])&&s++;return n},stringify:function(e){return"function"==this.typeOf(e)?""+e:JSON.stringify(e)}}}.call(this),a=function(){return{__namespace:"Scoped",__revert:null,upgrade:function(e){var t=h.get(e||a.__namespace);if(t&&"object"==p.typeOf(t)&&t.guid==this.guid&&"string"==p.typeOf(t.version)){for(var s=this.version.split("."),n=t.version.split("."),i=!1,o=0;o<Math.min(s.length,n.length)&&(i=parseInt(s[o],10)>parseInt(n[o],10),s[o]==n[o]);++o);return i?this.attach(e):t}return this.attach(e)},attach:function(e){e&&(a.__namespace=e);var t=h.get(a.__namespace);if(t==this)return this;if(a.__revert=t)try{var s=t.__exportScoped();this.__exportBackup=this.__exportScoped(),this.__importScoped(s)}catch(n){}return h.set(a.__namespace,this),this},detach:function(e){return e&&h.set(a.__namespace,null),"undefined"!=typeof a.__revert&&h.set(a.__namespace,a.__revert),delete a.__revert,a.__exportBackup&&this.__importScoped(a.__exportBackup),this},exports:function(e,t,s){return"object"==typeof(e=e||("undefined"!=typeof module?module:null))&&e&&"exports"in e&&(s||e.exports==this||!e.exports||p.isEmpty(e.exports))&&(e.exports=t||this),this}}}.call(this);function f(e){var a={tree:"boolean"==typeof e.tree&&e.tree,global:"boolean"==typeof e.global&&e.global,root:"object"==typeof e.root?e.root:{}};function i(e){return{route:"string"==typeof e.route?e.route:null,parent:"object"==typeof e.parent?e.parent:null,ready:"boolean"==typeof e.ready&&e.ready,children:{},watchers:[],data:{},lazy:[]}}var r=i({ready:!0});if(a.tree)if(a.global){try{window&&(r.data=window)}catch(t){}try{global&&(r.data=global)}catch(t){}try{self&&(r.data=self)}catch(t){}}else r.data=a.root;function c(e){if(!e.ready)if(!e.parent||e.parent.ready){if(e.route&&e.parent&&e.route in e.parent.data){e.data=e.parent.data[e.route],e.ready=!0;for(var t=0;t<e.watchers.length;++t)e.watchers[t].callback.call(e.watchers[t].context||this,e.data);for(var s in e.watchers=[],e.children)c(e.children[s])}}else c(e.parent)}function o(e,t){if("object"==typeof t&&e.ready)for(var s in t)e.data[s]=t[s];else e.data=t;if("object"==typeof t)for(var n in t)e.children[n]&&(e.children[n].data=t[n]);for(var i in function o(e){if(!e.ready){e.parent&&!e.parent.ready&&o(e.parent),e.ready=!0,e.parent&&a.tree&&"object"==typeof e.parent.data&&(e.parent.data[e.route]=e.data);for(var t=0;t<e.watchers.length;++t)e.watchers[t].callback.call(e.watchers[t].context||this,e.data);e.watchers=[]}}(e),e.children)c(e.children[i])}function _(e){if(!e)return r;for(var t=e.split("."),s=r,n=0;n<t.length;++n)t[n]in s.children?s=s.children[t[n]]:(s.children[t[n]]=i({parent:s,route:t[n]}),c(s=s.children[t[n]]));return s}return{extend:function(e,t){o(_(e),t)},set:function(e,t){var s=_(e);s.data&&!function n(e){if(e.ready&&e.data)for(var t in e.data)delete e.data[t]}(s),o(s,t)},get:function(e){var t=_(e);return t.ready?t.data:null},lazy:function(e,t,s){var n=_(e);n.ready?t(s||this,n.data):n.lazy.push({callback:t,context:s})},digest:function(e){c(_(e))},obtain:function(e,t,s){!function i(e,t,s){if(e.ready)t.call(s||this,e.data);else if(e.watchers.push({callback:t,context:s}),0<e.lazy.length){var n=function(e){if(0<e.lazy.length){var t=e.lazy.shift();t.callback.call(t.context||this,e.data),n(e)}};n(e)}}(_(e),t,s)},unresolvedWatchers:function(e){return function o(e,t,s){for(var n in s=s||[],!(e=e||r).ready&&0===e.lazy.length&&0<e.watchers.length&&s.push(t),e.children){var i=e.children[n];s=o(i,(t?t+".":"")+i.route,s)}return s}(_(e),e)},__export:function(){return{options:a,nsRoot:r}},__import:function(e){a=e.options,r=e.nsRoot}}}var t=f({tree:!0,global:!0}),s=f({tree:!0}),n=function m(e,t,s,n){function i(o,a,r){function e(){this.require(c.dependencies,c.hiddenDependencies,function(){for(var e=[],t=0;t<arguments.length;++t)e.push(arguments[t]);if(e[e.length-1].ns=_,this.options.compile){for(var s=[],n=0;n<o.length;++n)s.push(p.stringify(o[n]));this.compiled+=this.options.ident+"."+a+"("+s.join(", ")+");\n\n"}this.options.dependencies&&(this.dependencies[_.path]=this.dependencies[_.path]||{},c.dependencies&&c.dependencies.forEach(function(e){this.dependencies[_.path][this.resolve(e).path]=!0},this),c.hiddenDependencies&&c.hiddenDependencies.forEach(function(e){this.dependencies[_.path][this.resolve(e).path]=!0},this));var i=this.options.compile?{}:c.callback.apply(c.context||this,e);r.call(this,_,i)},this)}var c=p.matchArgs(o,{options:"object",namespaceLocator:!0,dependencies:"array",hiddenDependencies:"array",callback:!0,context:"object"}),t=p.extend({lazy:this.options.lazy},c.options||{}),_=this.resolve(c.namespaceLocator);return t.lazy?_.namespace.lazy(_.path,e,this):e.apply(this),this}var o=null,a=[],r=t,c=s,_=n,u=f({tree:!0}),d=f({tree:!1}),l={global:{namespace:_},root:{namespace:c},local:{namespace:u},"default":{namespace:d},parent:{namespace:r},scope:{namespace:u,readonly:!1}};return{getGlobal:p.method(h,h.getPath),setGlobal:p.method(h,h.setPath),options:{lazy:!1,ident:"Scoped",compile:!1,dependencies:!1},compiled:"",dependencies:{},nextScope:function(){return o||(o=m(this,u,c,_)),o},subScope:function(){var e=this.nextScope();return a.push(e),o=null,e},binding:function(e,t,s){var n;return l[e]&&l[e].readonly||(n="string"!=p.typeOf(t)?{namespace:f({tree:!0,root:t}),path:null}:this.resolve(t),l[e]=p.extend(s,n)),this},resolve:function(e){var t=e.split(":");if(1==t.length)throw"The locator '"+t[0]+"' requires a namespace.";var s=l[t[0]];if(!s)throw"The namespace '"+t[0]+"' has not been defined (yet).";return{namespace:s.namespace,path:s.path&&t[1]?s.path+"."+t[1]:s.path||t[1]}},define:function(){return i.call(this,arguments,"define",function(e,t){if(e.namespace.get(e.path))throw"Scoped namespace "+e.path+" has already been defined. Use extend to extend an existing namespace instead";e.namespace.set(e.path,t)})},assumeVersion:function(){var o=p.matchArgs(arguments,{assumption:!0,dependencies:"array",callback:!0,context:"object",error:"string"}),e=o.dependencies||[];e.unshift(o.assumption),this.require(e,function(){var e=arguments,t=e[0].replace(/[^\d\.]/g,"");e[0]=t.split(".");for(var s=0;s<e[0].length;++s)e[0][s]=parseInt(e[0][s],10);if("function"===p.typeOf(o.callback)){if(!o.callback.apply(o.context||this,o))throw"Scoped Assumption '"+o.assumption+"' failed, value is "+t+(o.error?", but assuming "+o.error:"")}else for(var n=(o.callback+"").replace(/[^\d\.]/g,"").split("."),i=0;i<Math.min(e[0].length,n.length);++i)if(parseInt(n[i],10)>e[0][i])throw"Scoped Version Assumption '"+o.assumption+"' failed, value is "+t+", but assuming at least "+o.callback})},extend:function(){return i.call(this,arguments,"extend",function(e,t){e.namespace.extend(e.path,t)})},require:function(){var t=p.matchArgs(arguments,{dependencies:"array",hiddenDependencies:"array",callback:"function",context:"object"});t.callback=t.callback||function(){};var e=t.dependencies||[],s=e.concat(t.hiddenDependencies||[]),n=s.length,i=[],o={};if(n){function a(e){this.i<i.length&&(i[this.i]=e),0==--n&&(i.push(o),t.callback.apply(t.context||this.ctx,i))}for(var r=0;r<s.length;++r){var c=this.resolve(s[r]);r<e.length&&i.push(null),c.namespace.obtain(c.path,a,{ctx:this,i:r})}}else i.push(o),t.callback.apply(t.context||this,i);return this},digest:function(e){var t=this.resolve(e);return t.namespace.digest(t.path),this},unresolved:function(e){var t=this.resolve(e);return t.namespace.unresolvedWatchers(t.path)},__export:function(){return{parentNamespace:r.__export(),rootNamespace:c.__export(),globalNamespace:_.__export(),localNamespace:u.__export(),privateNamespace:d.__export()}},__import:function(e){r.__import(e.parentNamespace),c.__import(e.rootNamespace),_.__import(e.globalNamespace),u.__import(e.localNamespace),d.__import(e.privateNamespace)}}}(0,s,s,t),e=p.extend(n,function(){return{guid:"4b6878ee-cb6a-46b3-94ac-27d91f58d666",version:"0.0.19",upgrade:a.upgrade,attach:a.attach,detach:a.detach,exports:a.exports,__exportScoped:function(){return{globalNamespace:t.__export(),rootNamespace:s.__export(),rootScope:n.__export()}},__importScoped:function(e){t.__import(e.globalNamespace),s.__import(e.rootNamespace),n.__import(e.rootScope)}}}.call(this));return(e=e.upgrade()).exports(),e}.call(this);(function(){var d=this.subScope();d.binding("module","global:BetaJS.Server"),d.binding("base","global:BetaJS"),d.binding("data","global:BetaJS.Data"),d.define("module:",function(){return{guid:"9955100d-6a88-451f-9a85-004523eb8589",version:"1.0.25",datetime:1561772447761}}),d.assumeVersion("base:version","~1.0.104"),d.assumeVersion("data:version","~1.0.41"),d.define("module:Ajax.NodeAjax",["base:Ajax.Support","base:Net.Uri","base:Net.HttpHeader","base:Promise","base:Objs","base:Types"],function(_,u,d,l,h,p){var e={supports:function(e){return!0},execute:function(s){var e=u.appendUriParams(s.uri,s.query||{});"GET"===s.method&&(e=u.appendUriParams(e,s.data||{}));var t=u.parse(e),n={method:s.method,host:t.host,port:t.port,path:t.path+(t.query?"?"+t.query:""),headers:{}};t.user||t.password?n.headers.Authorization="Basic "+new Buffer(t.user+":"+t.password).toString("base64"):s.bearer&&(n.headers.Authorization="Bearer "+s.bearer);var i=null,o=null;if("GET"!==s.method&&!p.is_empty(s.data)){var a=require("fs");h.iter(s.data,function(e){!o&&e instanceof a.ReadStream&&(o=new(require("form-data")))}),o?h.iter(s.data,function(e,t){o.append(t,e)}):i="json"===s.contentType?(s.sendContentType&&(n.headers["Content-Type"]="application/json;charset=UTF-8"),JSON.stringify(s.data)):(s.sendContentType&&(n.headers["Content-type"]="application/x-www-form-urlencoded"),u.encodeUriParams(s.data,undefined,!0)),i&&(n.headers["Content-Length"]=i.length)}var r=l.create();s.cookies&&(n.headers.Cookie=u.encodeUriParams(s.cookies)),o&&(n.headers=h.extend(n.headers,o.getHeaders()));var c=require("https"===t.protocol?"https":"http").request(n,function(e){var t="";e.on("data",function(e){t+=e}).on("end",function(){d.isSuccessStatus(e.statusCode)?_.promiseReturnData(r,s,t,s.decodeType||"json"):_.promiseRequestException(r,e.statusCode,e.statusText,t,s.decodeType||"json")})});return s.timeout&&c.on("socket",function(e){e.removeAllListeners("timeout"),e.setTimeout(s.timeout,function(){}),e.on("timeout",function(){c.abort()})}).on("timeout",function(){_.promiseTimeoutException(r),c.abort()}),o?o.pipe(c):(i&&0<i.length&&c.write(i),c.end()),r}};return _.register(e,10),e}),d.define("module:Net.ControllerException",["base:Exceptions.Exception","base:Net.HttpHeader"],function(e,n,t){return e.extend({scoped:t},function(s){return{constructor:function(e,t){t=t||{},this.__data=t,this.__code=e,s.constructor.call(this,n.format(e,!0))},code:function(){return this.__code},data:function(){return this.__data}}})}),d.define("module:Net.Controller",["base:Class","base:Promise","base:Types","module:Net.ControllerException"],function(e,o,a,r,t){return e.extend({scoped:t},{},{_beforeDispatch:function(e,t,s){return o.create(!0)},_dispatch:function(e,t,s){return this[e](t,s)},dispatch:function(t,s,n,i){this._beforeDispatch(t,s,n).success(function(){var e=this._dispatch(t,s,n);(e=o.is(e)?e:o.create(!0)).success(function(){a.is_defined(i)&&i()}).error(function(e){e=r.ensure(e),n.status(e.code()).send(JSON.stringify(e.data()))})},this).error(function(e){e=r.ensure(e),n.status(e.code()).send(JSON.stringify(e.data()))})}})}),d.define("module:Net.SessionControllerMixin",function(){return{_obtainSession:function(t,s,e,n,i){return t.obtain_session(n.cookies[s]).mapSuccess(function(e){return n.session=e,i.cookie(s,e.cid(),{maxAge:t.options().invalidation.session_timeout}),e})}}}),d.define("module:Sessions.ActiveSessionHelper",["base:Class","base:Classes.HelperClassMixin","base:Lists.ObjectIdList","base:Tokens"],function(e,t,n,i,s){return e.extend({scoped:s},[t,function(s){return{constructor:function(e,t){s.constructor.call(this),this.__helper=t,((this.__session=e).active_sessions=this).__active_sessions=new n},destroy:function(){this.iterate(function(e){e.destroy()},this),this.__active_sessions.destroy(),s.destroy.call(this)},session:function(){return this.__session},helper:function(){return this.__helper},invalidate:function(){this.iterate(function(e){e.invalidate()},this)},iterate:function(e,t){this.__active_sessions.iterate(e,t||this)},is_active:function(){return 0<this.__active_sessions.count()},find_active_session:function(e){return this.__active_sessions.get(e)},__generate_token:function(){return i.generate_token()},__remove_active_session:function(e){this.__active_sessions.exists(e)&&(this.__active_sessions.remove(e),this.__session.activity())},delete_active_session:function(e){e.destroy()},obtain_active_session:function(e,t){return this.find_active_session(e)||this.new_active_session(e,t)},__add_active_session:function(e){this.__active_sessions.add(e),this.session().manager().__add_active_session(this.session(),e)},new_active_session:function(e,t){var s=new this.__helper._active_session_class(this,e||this.__generate_token(),t);return this.__add_active_session(s),s},continue_active_session:function(t){var s=null;return this.iterate(function(e){return!e.suspended()||!e.can_continue(t)||(s=e,!1)}),s},attach_active_session:function(e){return this.continue_active_session(e)||this.new_active_session(null,e)}}}])}),d.define("module:Sessions.ActiveSession",["base:Class","base:Classes.HelperClassMixin","base:Events.EventsMixin","base:Ids","base:Time"],function(e,t,s,i,o,n){return e.extend({scoped:n},[t,s,function(n){return{constructor:function(e,t,s){n.constructor.call(this),this.__helper=e,this.__options=s||{},i.objectId(this,t),this.initiation_time=o.now(),this.active_time=this.initiation_time},destroy:function(){this.trigger("destroy"),this.__helper.__remove_active_session(this),n.destroy.call(this)},session:function(){return this.__helper.session()},options:function(){return this.__options},activity:function(){this.active_time=o.now()},suspended:function(){return this._helper({method:"suspended",fold_start:!1,fold:function(e,t){return e||t}})},can_continue:function(e){return!1},invalidate:function(){var e=this.__helper.helper().options().invalidation,t=o.now();(e.active_session_timeout&&t>this.initiation_time+e.active_session_timeout||this.suspended()&&e.active_session_inactivity_timeout&&t>this.active_time+e.active_session_inactivity_timeout)&&this.destroy()}}}])}),d.define("module:Sessions.ActiveSessionManagerHelper",["base:Class","module:Sessions.ActiveSession","module:Sessions.ActiveSessionHelper","base:Objs","base:Types"],function(e,t,n,i,o,s){return e.extend({scoped:s},function(s){return{_active_session_class:t,constructor:function(e,t){s.constructor.call(this),t=i.tree_extend({invalidation:{active_session_timeout:36e5,active_session_inactivity_timeout:6e4}},t),this.__options=t,this._active_session_class=t.active_session_class||this._active_session_class,o.is_string(this._active_session_class)&&(this._active_session_class=d.getGlobal(this._active_session_class)),e.__add_active_session=function(e,t){this._helper("__add_active_session",e,t)}},__add_session:function(e){e.addHelper(n,this)},options:function(){return this.__options}}})}),d.define("module:Sessions.PersistentSessionModel",["data:Modelling.Model"],function(e,t){return e.extend({scoped:t},{},function(t){return{_initializeScheme:function(){var e=t._initializeScheme.call(this);return e.token={type:"string",index:!0},e.created={type:"date",index:!0},e}}})}),d.define("module:Sessions.PersistentSessionManagerHelper",["base:Class","module:Sessions.PersistentSessionModel","base:Objs","base:Types","data:Stores.MemoryStore","data:Modelling.Table","base:Timers.Timer","base:Time"],function(e,t,n,i,o,a,r,c,s){return e.extend({scoped:s},function(s){return{_persistent_session_model:t,constructor:function(e,t){s.constructor.call(this),this.__manager=e,t=n.tree_extend({invalidation:{session_timeout:31536e6,timer:864e5}},t),this.__options=t,this.__store=t.store?t.store:this._auto_destroy(new o),this._persistent_session_model=t.persistent_session_model||this._persistent_session_model,i.is_string(this._persistent_session_model)&&(this._persistent_session_model=d.getGlobal(this._persistent_session_model)),t.invalidation.timer&&(this.__timer=this._auto_destroy(new r({fire:this.invalidate,context:this,delay:t.invalidation.timer}))),this._persistent_session_model.table||(this._persistent_session_model.table=this._auto_destroy(new a(this.__store,this._persistent_session_model))),this.__table=this._persistent_session_model.table,e.table=this.__table,e.store=this.__store},__lookup_session:function(s){return this.__table.findBy({token:s}).mapCallback(function(e,t){return t&&!e?this.__manager.new_session(s,{model:t}):null},this)},__add_session:function(e){var t=e.options();t.model||(t.model=this.__table.newModel({token:e.cid(),created:c.now()}),t.model.save()),e.model=t.model,e.model.session=e},options:function(){return this.__options},invalidate:function(){if(this.__options.invalidation.session_timeout){var e=c.now()-this.__options.invalidation.session_timeout;this.__table.allBy({created:{$lt:e}}).success(function(e){for(;e.hasNext();){var t=e.next();t.session&&this.__manager.delete_session(t.session),t.remove()}},this)}}}})}),d.define("module:Sessions.RMIHelper",["base:Class","base:Channels.ReadySender","base:Net.SocketSenderChannel","base:Net.SocketReceiverChannel","base:RMI.Peer"],function(e,s,n,i,o,t){return e.extend({scoped:t},function(t){return{constructor:function(e){t.constructor.call(this),((this.__active_session=e).rmi=this).__rmi_sender=new s(new n(null,"rmi")),this.__rmi_receiver=new i(null,"rmi"),this.__rmi_peer=new o(this.__rmi_sender,this.__rmi_receiver),e.rmi_peer=this.__rmi_peer,this.stubs={},this.skeletons={},e.stubs=this.stubs,e.skeletons=this.skeletons,e.on("bind_socket",function(e){this.__rmi_receiver.socket(e),this.__rmi_sender.socket(e),this.__rmi_sender.ready()},this),e.on("unbind_socket",function(){this.__rmi_sender.unready()},this),"initialize_rmi"in e&&e.initialize_rmi()},destroy:function(){for(var e in this.stubs)this.stubs[e].destroy();for(e in this.skeletons)this.skeletons[e].destroy();this.__rmi_peer.destroy(),this.__rmi_receiver.destroy(),this.__rmi_sender.destroy(),t.destroy.call(this)}}})}),d.define("module:Sessions.RMIManagerHelper",["base:Class","module:Sessions.RMIHelper"],function(e,s,t){return e.extend({scoped:t},{__add_active_session:function(e,t){t.addHelper(s)}})}),d.define("module:Sessions.Session",["base:Class","base:Classes.HelperClassMixin","base:Ids","base:Time"],function(e,t,i,o,s){return e.extend({scoped:s},[t,function(n){return{constructor:function(e,t,s){n.constructor.call(this),this.__manager=e,this.__options=s||{},i.objectId(this,t),this.initiation_time=o.now(),this.active_time=this.initiation_time},destroy:function(){this.__manager.__remove_session(this),n.destroy.call(this)},is_active:function(){return this._helper({method:"is_active",fold_start:!1,fold:function(e,t){return e||t}})},activity:function(){this.active_time=o.now()},invalidate:function(){this._helper("invalidate");var e=this.__manager.options().invalidation,t=o.now();(e.session_timeout&&t>this.initiation_time+e.session_timeout||!this.is_active()&&e.session_inactivity_timeout&&t>this.active_time+e.session_inactivity_timeout)&&this.destroy()},manager:function(){return this.__manager},options:function(){return this.__options}}}])}),d.define("module:Sessions.Manager",["base:Class","base:Events.EventsMixin","base:Classes.HelperClassMixin","module:Sessions.Session","base:Objs","base:Types","base:Timers.Timer","base:Lists.ObjectIdList","base:Tokens","base:Promise"],function(e,t,s,n,i,o,a,r,c,_,u){return e.extend({scoped:u},[t,s,function(t){return{_session_class:n,constructor:function(e){t.constructor.call(this),e=i.tree_extend({invalidation:{session_timeout:864e5,session_inactivity_timeout:36e5,timer:6e4}},e),this.__options=e,this._session_class=e.session_class||this._session_class,o.is_string(this._session_class)&&(this._session_class=d.getGlobal(this._session_class)),e.invalidation.timer&&(this.__timer=this._auto_destroy(new a({fire:this.invalidate,context:this,delay:e.invalidation.timer}))),this.__sessions=new r},destroy:function(){this.iterate(function(e){e.destroy()}),this.__sessions.destroy(),t.destroy.call(this)},iterate:function(e,t){this.__sessions.iterate(e,t||this)},obtain_session:function(e,t){return this.find_session(e).mapSuccess(function(e){return e||this.new_session(null,t)},this)},__generate_token:function(){return c.generate_token()},__lookup_session:function(e){return this._helper({method:"__lookup_session",async:!0},e)},get_session:function(e){return this.__sessions.get(e)},find_session:function(e){if(!e)return _.value(null);var t=this.get_session(e);return t?_.create(t):this.__lookup_session(e)},__add_session:function(e){this.__sessions.add(e),this._helper("__add_session",e)},new_session:function(e,t){var s=new this._session_class(this,e||this.__generate_token(),t);return this.__add_session(s),s},invalidate:function(){this.iterate(function(e){e.invalidate()})},options:function(){return this.__options},__remove_session:function(e){this.__sessions.exists(e)&&(this._helper("remove_session",e),this.__sessions.remove(e))},delete_session:function(e){e.destroy()}}}])}),d.define("module:Sessions.SocketsHelper",["base:Class"],function(e,t){return e.extend({scoped:t},function(t){return{constructor:function(e){t.constructor.call(this),(this.__active_session=e).socket=this},destroy:function(){this.unbind(),t.destroy.call(this)},suspended:function(){return!this.socket()},bind:function(e){if(e!=this.__socket){this.unbind(),this.__socket=e;var t=this;e.on("disconnect",function(){t.unbind()}),this.__active_session.trigger("bind_socket",e)}},unbind:function(){if(this.__socket){var e=this.__socket;this.__socket=null,this.__active_session.activity(),this.__active_session.trigger("unbind_socket",e),this.__active_session.session().manager().sockets_manager_helper.__options.remove_on_disconnect&&this.__active_session.destroy()}},socket:function(){return this.__socket}}})}),d.define("module:Sessions.SocketsManagerHelper",["base:Class","base:Objs","base:Net.Cookies","module:Sessions.SocketsHelper"],function(e,n,i,o,t){return e.extend({scoped:t},function(s){return{constructor:function(e,t){s.constructor.call(this),((this.__manager=e).sockets_manager_helper=this).__options=n.extend({remove_on_disconnect:!1},t),e.bind_socket=function(s,e,n){var t=i.getCookielikeValue(s.handshake.headers.cookie,e);t||(t=s.handshake.query[e]),this.find_session(t).success(function(e){if(e){var t=e.active_sessions.find_active_session(n.active_session_token);t?t.socket.bind(s):s.disconnect()}else s.disconnect()},this)}},__add_active_session:function(e,t){t.addHelper(o)}}})})}).call(Scoped);